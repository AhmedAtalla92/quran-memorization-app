<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    
    <!-- iOS Web App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hafez Quraan">
    
    <!-- App Icons for iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/AhmedAtalla92/quran-memorization-app/main/Hafez%20Quraan%20Logo.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/AhmedAtalla92/quran-memorization-app/main/Hafez%20Quraan%20Logo.png">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#1a4d2e">
    
    <title>Hafez Quraan - Quran Memorization</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a4d2e;
            --secondary: #d4af37;
            --accent: #8b6f47;
            --bg-light: #faf8f3;
            --bg-dark: #0f1a14;
            --text-primary: #2c3e2f;
            --text-light: #6b7c6e;
            --border: #d4c5a9;
            --success: #2d6a4f;
            --error: #9d4747;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Decorative Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(26, 77, 46, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            text-align: center;
            padding: 1.5rem 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
            position: relative;
        }

        h1 {
            font-family: 'Amiri', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 300;
        }

        /* Navigation */
        nav {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--primary) 0%, #2d6a4f 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-family: 'Crimson Pro', serif;
            cursor: pointer;
            border-radius: 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--secondary);
            transition: left 0.3s ease;
            z-index: 0;
        }

        .nav-btn:hover::before {
            left: 0;
        }

        .nav-btn span {
            position: relative;
            z-index: 2;
            color: white;
        }

        .nav-btn.active {
            background: var(--secondary);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        
        .nav-btn.active::before {
            left: 0;
        }

        /* Page Sections */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Styling */
        .card {
            background: white;
            border: 2px solid var(--border);
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 0.1;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.35rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        input, select {
            width: 100%;
            padding: 0.65rem;
            border: 2px solid var(--border);
            background: var(--bg-light);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Prevent zoom on iOS */
        @supports (-webkit-touch-callout: none) {
            input, select {
                font-size: 16px;
            }
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            font-family: 'Crimson Pro', serif;
            font-weight: 600;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
            min-height: 44px; /* Apple's recommended minimum touch target */
        }
        
        button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* Better mobile button behavior */
        @media (hover: none) and (pointer: coarse) {
            button:hover {
                transform: none;
            }
            button:active {
                background: var(--accent);
            }
        }

        /* Progress Meter */
        .progress-container {
            margin: 1.25rem 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: var(--bg-light);
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--secondary) 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Verse Display */
        .verse-card {
            background: white;
            border: 2px solid var(--border);
            padding: 0.65rem 0.85rem;
            margin: 0.35rem 0;
            position: relative;
        }

        .verse-arabic {
            font-family: 'Amiri', serif;
            font-size: 1.6rem;
            line-height: 1.75;
            color: var(--primary);
            margin: 0.35rem 0;
            direction: rtl;
        }

        .verse-translation {
            font-size: 1rem;
            color: var(--text-light);
            font-style: italic;
            margin: 0.35rem 0 0.5rem 0;
        }

        .verse-info {
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.35rem;
        }
        
        .verse-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border);
        }
        
        .verse-controls-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }

        /* Memorized Toggle */
        .memorized-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 26px;
            background: #ccc;
            border-radius: 26px;
            cursor: pointer;
            transition: background 0.3s ease;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch.recited-active {
            background: linear-gradient(135deg, #c8860a, #e8a020);
        }

        /* Recited toggle slider stays in place - only color changes */
        .toggle-switch.recited-active .toggle-slider {
            transform: translateX(0) !important;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        /* RTL Support for buttons */
        [dir="rtl"] button {
            text-align: right;
        }
        
        [dir="rtl"] .nav-btn {
            text-align: center;
        }
        
        [dir="rtl"] .verse-controls {
            flex-direction: row-reverse;
        }
        
        [dir="rtl"] .verse-controls-left {
            flex-direction: row-reverse;
        }
        
        /* Audio Player */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .audio-btn {
            background: var(--secondary);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .audio-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 3px 9px rgba(26, 77, 46, 0.4);
        }
        
        .audio-btn:active {
            transform: scale(0.95);
        }
        
        /* Mobile-specific audio button behavior */
        @media (hover: none) and (pointer: coarse) {
            .audio-btn:hover {
                transform: none;
            }
            .audio-btn:active {
                transform: scale(0.9);
                background: var(--primary);
            }
        }
        
        .audio-btn.playing {
            background: var(--success);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 2px 6px rgba(45, 106, 79, 0.3); }
            50% { box-shadow: 0 3px 12px rgba(45, 106, 79, 0.6); }
        }

        /* Quiz Styles */
        .quiz-question {
            font-family: 'Amiri', serif;
            font-size: 1.5rem;
            line-height: 1.8;
            color: var(--primary);
            margin: 1.25rem 0;
            direction: rtl;
            text-align: center;
        }

        .quiz-blank {
            display: inline-block;
            min-width: 120px;
            border-bottom: 3px solid var(--secondary);
            margin: 0 8px;
            text-align: center;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin: 1.25rem 0;
        }

        .quiz-option {
            padding: 1rem;
            background: white;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-family: 'Amiri', serif;
            font-size: 1.15rem;
        }

        .quiz-option:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .quiz-option.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .quiz-option.incorrect {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: white;
            border: 2px solid var(--border);
            padding: 1.25rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Amiri', serif;
        }

        .stat-label {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-top: 0.35rem;
        }

        /* Message Box */
        .message {
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--success);
            background: rgba(45, 106, 79, 0.1);
            font-size: 1.1rem;
        }

        .message.error {
            border-left-color: var(--error);
            background: rgba(157, 71, 71, 0.1);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .loading::before {
            content: '';
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            /* Compact header */
            h1 { font-size: 1.8rem; margin: 0.5rem 0; }
            .subtitle { font-size: 0.8rem; }
            
            /* Compact navigation */
            .nav-btn { padding: 0.5rem 1rem; font-size: 0.85rem; }
            
            /* DEFAULT (Surah view) - BIGGER font for mobile */
            .verse-arabic { 
                font-size: 1.4rem !important; 
                line-height: 2.2 !important; 
            }
            
            /* Page view card - compact padding */
            .verse-card[style*="padding: 2.5rem"] {
                padding: 0.75rem !important;
            }
            
            /* Page view Arabic text - match surah view style */
            .verse-card[style*="padding: 2.5rem"] > div[style*="font-size: 2rem"] {
                font-size: 1.4rem !important;
                line-height: 2.2 !important;
                padding: 1rem !important;
                margin: 1rem 0 !important;
                background: transparent !important;
            }
            
            /* Page header compact */
            .verse-card div[style*="font-size: 1.2rem"] {
                font-size: 0.85rem !important;
                margin-bottom: 0.75rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            .verse-card div[style*="font-size: 0.9rem"] {
                font-size: 0.7rem !important;
                margin-top: 0.25rem !important;
            }
            
            /* Page controls compact */
            .verse-card div[style*="margin-top: 2rem"][style*="padding-top: 1.5rem"] {
                margin-top: 1rem !important;
                padding-top: 1rem !important;
            }
            
            /* Compact card padding */
            .card {
                padding: 1rem !important;
            }
            
            .verse-card {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Compact page title */
            h2 {
                font-size: 1.3rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .quiz-question { font-size: 1.1rem; }
            
            /* 3 filters per row on mobile - compact */
            .filters { 
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.4rem;
            }
            
            .form-group {
                margin-bottom: 0.5rem;
            }
            
            /* Compact stats cards on mobile */
            .stat-card {
                padding: 0.75rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .stat-card h3 {
                font-size: 1.1rem !important;
                margin-bottom: 0.35rem !important;
            }
            
            .stat-card .stat-value {
                font-size: 1.4rem !important;
            }
            
            /* Compact progress containers */
            .progress-container {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .progress-label {
                font-size: 0.85rem !important;
                margin-bottom: 0.4rem !important;
            }
            
            .progress-bar {
                height: 6px !important;
            }
            
            /* Fix filter button text overflow */
            .filters select,
            .filters button {
                font-size: 0.75rem !important;
                padding: 0.4rem 0.3rem !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .filters label {
                font-size: 0.75rem !important;
                margin-bottom: 0.2rem !important;
            }
            
            /* Mobile filter layout adjustments */
            .form-group {
                margin-bottom: 0.6rem !important;
            }
            
            .form-group label {
                font-size: 0.8rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            /* Mobile filter inputs - better sizing */
            .form-group select,
            .form-group input {
                padding: 0.5rem 0.4rem !important;
                font-size: 0.9rem !important;
            }
            
            /* Top filter (All/Memorized/Not Memorized) */
            #viewFilter {
                font-size: 0.8rem !important;
                padding: 0.4rem 0.5rem !important;
            }
            
            /* Mobile header adjustments */
            .card > div[style*="justify-content: space-between"] {
                margin-bottom: 0.75rem !important;
            }
            
            .card h2 {
                font-size: 1.2rem !important;
            }
            
            /* Smaller buttons on mobile */
            button {
                padding: 0.5rem 0.9rem;
                font-size: 0.85rem;
            }
            
            /* Even smaller bookmark button */
            .bookmark-btn {
                font-size: 0.7rem !important;
                padding: 0.3rem 0.5rem !important;
            }
            
            /* Mobile: Keep preferences on one line, smaller */
            #accountDashboard > div[style*="grid-template-columns"] {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.5rem !important;
            }
            
            #accountDashboard .form-group label {
                font-size: 0.75rem !important;
            }
            
            #accountDashboard .form-group select {
                font-size: 0.8rem !important;
                padding: 0.4rem 0.3rem !important;
            }
            
            /* Mobile: Page toggles on same line with smaller font */
            #pageToggle, #pageRecitedToggle {
                transform: scale(0.9);
            }
            
            .verse-card div[style*="grid-template-columns: auto auto auto auto"] span {
                font-size: 0.8rem !important;
            }
            
            /* Mobile: Fix recitation meter alignment */
            #accountDashboard > div[style*="grid-template-columns: 140px 1fr"] {
                grid-template-columns: 120px 1fr !important;
                gap: 0.75rem !important;
            }
            
            #accountDashboard .stat-card {
                padding: 0.75rem !important;
            }
            
            #accountDashboard .stat-value {
                font-size: 1.5rem !important;
            }
            
            #accountDashboard .stat-label {
                font-size: 0.7rem !important;
            }
            
            #accountDashboard .progress-label {
                font-size: 0.8rem !important;
            }
            
            #accountDashboard .progress-label span {
                font-size: 0.75rem !important;
            }
            
            /* Page view buttons - very compact */
            #playPageBtn, #pausePageBtn, #restartPageBtn {
                padding: 0.4rem 0.6rem !important;
                font-size: 0.7rem !important;
            }
            
            /* Stats grid - single column */
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem;
            }
            
            .stat-card {
                padding: 1rem !important;
            }
            
            .stat-value {
                font-size: 1.8rem !important;
            }
            
            .stat-label {
                font-size: 0.75rem !important;
            }
            
            /* Verse info smaller */
            .verse-info {
                font-size: 0.7rem;
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            /* Translation text */
            .verse-translation {
                font-size: 0.85rem;
                margin: 0.75rem 0;
            }
            
            /* Page controls container - compact */
            div[style*="justify-content: space-between"] {
                flex-direction: column !important;
                gap: 0.75rem !important;
                margin-top: 1rem !important;
                padding-top: 1rem !important;
            }
            
            /* Compact container padding */
            .container {
                padding: 0 0.75rem;
            }
            
            /* Compact header */
            header {
                padding: 0.75rem 0;
            }
        }

        /* Prayer Times Styles */
        .prayer-time-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--bg-light);
            border-radius: 10px;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        .prayer-time-row.active {
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.1));
            border-left-color: var(--success);
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.15);
        }

        .prayer-time-row.passed {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ÿ≠ÿßŸÅÿ∏</h1>
            <div class="subtitle">Master the Noble Quran</div>
        </header>

        <nav>
            <button class="nav-btn active" onclick="showPage('account')" data-page="account">
                <span>Account</span>
            </button>
            <button class="nav-btn" onclick="showPage('memorize')" data-page="memorize">
                <span>Memorize</span>
            </button>
            <button class="nav-btn" onclick="showPage('pray')" data-page="pray">
                <span>Pray</span>
            </button>
        </nav>

        <!-- Install to Home Screen Banner (shows only on mobile) -->
        <div id="installBanner" style="display: none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem 1.25rem; margin: 0 0 1rem 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.05rem; margin-bottom: 0.35rem;">üì± Install Hafez App</div>
                    <div style="font-size: 0.85rem; opacity: 0.95;">Add to your home screen for quick access</div>
                </div>
                <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                    <button id="installBtn" onclick="installApp()" style="background: white; color: var(--primary); padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 600; border-radius: 8px; white-space: nowrap; border: none; cursor: pointer;">
                        Install
                    </button>
                    <button onclick="closeInstallBanner()" style="background: rgba(255,255,255,0.2); color: white; padding: 0.6rem 0.8rem; font-size: 0.9rem; border-radius: 8px; border: none; cursor: pointer;">
                        ‚úï
                    </button>
                </div>
            </div>
        </div>

        <!-- Account Page -->
        <div id="account" class="page active">
            <div class="card">
                <h2 style="font-family: 'Amiri', serif; font-size: 1.6rem; margin-bottom: 1.25rem; color: var(--primary);">
                    Your Account
                </h2>
                
                <div id="loginForm">
                    <!-- Email Input Step -->
                    <div id="emailStep">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input 
                                type="email"
                                id="email" 
                                name="email"
                                autocomplete="email"
                                placeholder="your@email.com" 
                                style="font-size: 16px;">
                        </div>
                        <button type="button" id="sendOtpBtn" style="width: 100%; background: var(--secondary); font-size: 1.1rem; padding: 1rem; margin-top: 0.5rem;">
                            Send Verification Code
                        </button>
                        <div style="margin-top: 0.75rem; text-align: center;">
                            <small style="color: var(--text-light);">We'll send a 6-digit code to your email</small>
                        </div>
                    </div>
                    
                    <!-- OTP Verification Step -->
                    <div id="otpStep" style="display: none;">
                        <div class="message" style="background: var(--bg-light); margin-bottom: 1rem; padding: 1rem;">
                            <div style="font-size: 0.95rem; color: var(--text-primary);">
                                üìß Verification code sent to: <strong id="otpEmailDisplay"></strong>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                                Code expires in <span id="otpTimer">5:00</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="otpInput">Enter 6-Digit Code</label>
                            <input 
                                type="text"
                                id="otpInput" 
                                maxlength="6"
                                pattern="[0-9]*"
                                inputmode="numeric"
                                placeholder="000000" 
                                style="font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem; font-weight: 600;">
                        </div>
                        
                        <button type="button" id="verifyOtpBtn" style="width: 100%; background: var(--success); font-size: 1.1rem; padding: 1rem; margin-top: 0.5rem;">
                            Verify & Sign In
                        </button>
                        
                        <button type="button" id="resendOtpBtn" style="width: 100%; background: var(--text-light); font-size: 0.95rem; padding: 0.75rem; margin-top: 0.5rem;">
                            Resend Code
                        </button>
                        
                        <button type="button" id="changeEmailBtn" style="width: 100%; background: transparent; color: var(--primary); border: 2px solid var(--primary); font-size: 0.95rem; padding: 0.75rem; margin-top: 0.5rem;">
                            Change Email
                        </button>
                    </div>
                </div>

                <div id="accountDashboard" style="display: none;">
                    <div class="message" id="welcomeMessage"></div>
                    
                    <!-- Preferences - all on one line -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem;">Language</label>
                            <select id="languageSelector" onchange="changeLanguage()" style="font-size: 0.9rem;">
                                <option value="en">English</option>
                                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem;">Translation</label>
                            <select id="showTranslation" onchange="toggleTranslationDisplay()" style="font-size: 0.9rem;">
                                <option value="english">English</option>
                                <option value="arabic">Arabic (ÿ™ŸÅÿ≥Ÿäÿ±)</option>
                                <option value="hide">Hide</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label id="labelReciter" style="font-size: 0.85rem;">Reciter</label>
                            <select id="reciterSelector" onchange="changeReciter()" style="font-size: 0.9rem;">
                                <option value="ar.alafasy">Mishary Alafasy</option>
                                <option value="Maher_AlMuaiqly_64kbps">Maher Al Muaiqly</option>
                                <option value="ahmed_ibn_ali_al_ajamy_128kbps">Ahmed Al Ajmi</option>
                                <option value="Saood_ash-Shuraym_64kbps">Saud Ash-Shuraim</option>
                                <option value="Ghamadi_40kbps">Saad Al-Ghamdi</option>
                                <option value="Yasser_Ad-Dussary_128kbps">Yasser Al-Dosari</option>
                                <option value="Hudhaify_128kbps">Ali Al-Hudhaify</option>
                                <option value="Abdul_Basit_Murattal_192kbps">Abdul Basit</option>
                                <option value="Abdurrahmaan_As-Sudais_192kbps">Abdurrahman As-Sudais</option>
                                <option value="Abu_Bakr_Ash-Shaatree_128kbps">Abu Bakr Ash-Shatri</option>
                            </select>
                        </div>
                    </div>

                    <!-- Recitation: Stat + Progress Bar on same line (FIRST) -->
                    <div style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                        <div class="stat-card" style="border-top: 3px solid #c8860a; margin-bottom: 0; text-align: center;">
                            <div class="stat-value" id="recitedCount" style="color: #c8860a; font-size: 1.8rem;">0</div>
                            <div class="stat-label" id="labelPagesRecited" style="font-size: 0.8rem;">Total Pages Recited</div>
                        </div>
                        <div class="progress-container" style="margin-bottom: 0;">
                            <div class="progress-label" style="margin-bottom: 0.4rem;">
                                <span id="labelRecitationProgress" style="color: #c8860a; font-weight: 600; font-size: 0.9rem;">Recitation Progress</span>
                                <div style="display: flex; align-items: center; gap: 0.6rem;">
                                    <span id="recitedProgressText" style="font-size: 0.85rem;">0 / 604</span>
                                    <button onclick="resetRecitedProgress()" title="Reset recitation progress" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #c8860a; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">‚Ü∫ Reset</button>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="recitedProgressFill" style="width: 0%; background: linear-gradient(90deg, #c8860a 0%, #e8a020 100%);"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Memorization Stats (top 3 cards) -->
                    <div class="stats-grid" style="margin-bottom: 1.5rem;">
                        <div class="stat-card">
                            <div class="stat-value" id="totalVerses">0</div>
                            <div class="stat-label" id="labelTotalVerses">Verses Memorized</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="completionPercent">0%</div>
                            <div class="stat-label" id="labelCompletion">Completion</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="surahCount">0</div>
                            <div class="stat-label" id="labelSurahsDone">Surahs Done</div>
                        </div>
                    </div>

                    <!-- Memorization Progress Bar -->
                    <div class="progress-container" style="margin-bottom: 1.5rem;">
                        <div class="progress-label">
                            <span id="labelMemorizationProgress" style="font-weight: 600;">Memorization Progress</span>
                            <div style="display: flex; align-items: center; gap: 0.6rem;">
                                <span id="progressText">0 / 6236 verses</span>
                                <button onclick="showPage('quiz')" style="padding: 0.3rem 0.7rem; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                                    <span id="btnQuiz">üìù Quiz</span>
                                </button>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Keep hidden element for reviewedCount (used by JS) -->
                    <div style="display: none;">
                        <div id="reviewedCount">0</div>
                        <div id="reviewProgressText">0 / 0</div>
                        <div id="reviewProgressFill"></div>
                    </div>

                    <!-- Bookmarked Ayahs Section -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                        <h3 style="font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üîñ Bookmarked Ayahs
                            <span id="bookmarkCount" style="font-size: 0.9rem; background: var(--secondary); color: white; padding: 0.2rem 0.6rem; border-radius: 12px;">0</span>
                        </h3>
                        
                        <div id="bookmarksEmpty" style="text-align: center; padding: 2rem; color: var(--text-light); display: none;">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìñ</div>
                            <div>No bookmarked ayahs yet</div>
                            <div style="font-size: 0.85rem; margin-top: 0.5rem;">Go to "By Page" view and click on ayah numbers to bookmark them</div>
                        </div>
                        
                        <div id="bookmarksList" style="display: none;">
                            <button onclick="viewAllBookmarks()" style="width: 100%; background: var(--secondary); margin-bottom: 1rem; font-size: 1rem; padding: 0.85rem;">
                                üìñ View All Bookmarked Ayahs
                            </button>
                            
                            <div id="bookmarksPreview" style="max-height: 300px; overflow-y: auto; background: var(--bg-light); border-radius: 8px; padding: 1rem;"></div>
                        </div>
                    </div>

                    <button onclick="logout()" style="background: var(--error); margin-top: 2rem;">Sign Out</button>
                </div>
            </div>
        </div>

        <!-- Memorize Page -->
        <div id="memorize" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
                    <h2 style="font-family: 'Amiri', serif; font-size: 1.6rem; margin: 0; color: var(--primary);">
                        Memorization/Recitation Practice
                    </h2>
                    <div id="memorizeFilterContainer" style="display: flex; align-items: center; gap: 0.5rem;">
                        <label id="labelFilter" style="font-size: 0.85rem; font-weight: 600; color: var(--accent);">Filter:</label>
                        <select id="viewFilter" onchange="changeView(this.value)" style="font-size: 0.85rem; padding: 0.45rem 0.65rem; border: 2px solid var(--accent); border-radius: 6px; background: var(--accent); color: white; font-weight: 600; cursor: pointer;">
                            <option value="all">All</option>
                            <option value="memorized">Memorized</option>
                            <option value="not_memorized">Not Memorized</option>
                        </select>
                    </div>
                </div>

                <!-- First row: View Mode, Juz, Surah -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label id="labelViewMode" style="font-size: 0.85rem; margin-bottom: 0.3rem;">View Mode</label>
                        <select id="viewModeFilter" onchange="switchViewMode()" style="font-size: 0.9rem;">
                            <option value="surah" id="optionBySurah">By Surah</option>
                            <option value="page" id="optionByPage">By Page</option>
                        </select>
                    </div>
                    <div class="form-group" id="juzFilterGroup" style="margin-bottom: 0;">
                        <label id="labelJuz" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Juz</label>
                        <select id="juzFilter" onchange="filterVerses()" style="font-size: 0.9rem;">
                            <option value="" id="optionAllJuz">All Juz</option>
                        </select>
                    </div>
                    <div class="form-group" id="surahFilterGroup" style="margin-bottom: 0;">
                        <label id="labelSurah" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Surah</label>
                        <select id="surahFilter" onchange="filterVerses()" style="font-size: 0.9rem;">
                            <option value="" id="optionAllSurahs">All Surahs</option>
                        </select>
                    </div>
                    <div class="form-group" id="pageFilterGroup" style="display:none; margin-bottom: 0;">
                        <label id="labelPage" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Page</label>
                        <select id="pageFilter" onchange="filterByPage()" style="font-size: 0.9rem;">
                            <option value="" id="optionSelectPage">Select Page</option>
                        </select>
                    </div>
                </div>

                <!-- Second row: Ayah Range -->
                <div class="form-group" id="ayahFilterGroup" style="margin-bottom: 1rem;">
                    <label id="labelAyah" style="font-size: 0.85rem; margin-bottom: 0.3rem;">Ayah Range</label>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center;">
                        <select id="ayahFrom" onchange="filterVerses()" style="font-size: 0.9rem;">
                            <option value="">From (All)</option>
                        </select>
                        <span style="color: var(--text-light); font-size: 0.8rem;">to</span>
                        <select id="ayahTo" onchange="filterVerses()" style="font-size: 0.9rem;">
                            <option value="">To (All)</option>
                        </select>
                    </div>
                </div>

                <div id="verseDisplay"></div>
            </div>
        </div>

        <!-- Bookmarks Page -->
        <div id="bookmarks" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 style="font-family: 'Amiri', serif; font-size: 1.6rem; margin: 0; color: var(--primary); flex: 1; min-width: 200px;">
                        üîñ Bookmarked Ayahs
                    </h2>
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0;">
                        <span style="font-size: 0.9rem; font-weight: 600; color: var(--primary);">Translation:</span>
                        <select id="bookmarkTranslationMode" onchange="changeBookmarkTranslation()" style="padding: 0.5rem 0.7rem; font-size: 0.9rem; border-radius: 6px; border: 2px solid var(--primary); background: white; font-weight: 600; min-width: 100px;">
                            <option value="hide">Hide</option>
                            <option value="english">English</option>
                            <option value="arabic">Arabic</option>
                        </select>
                    </div>
                </div>

                <div id="bookmarksEmpty" style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üìñ</div>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">No bookmarked ayahs yet</div>
                    <div style="font-size: 0.9rem;">Go to "Memorize" page and click "Save" on any ayah to bookmark it</div>
                </div>

                <div id="bookmarksDisplay"></div>
            </div>
        </div>

        <!-- Quiz Page -->
        <div id="quiz" class="page">
            <div class="card">
                <h2 style="font-family: 'Amiri', serif; font-size: 1.6rem; margin-bottom: 1.25rem; color: var(--primary);">
                    Test Your Memory
                </h2>

                <div id="quizSetup">
                    <div class="form-group">
                        <label id="labelSelectSurah">Select Memorized Surah to Review</label>
                        <select id="quizSurahFilter" onchange="updateQuizAyahRange()">
                            <option value="" id="optionAllMemorized">All Memorized Verses</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label id="labelAyahRange">Ayah Range</label>
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.5rem; align-items: center;">
                            <select id="quizAyahFrom">
                                <option value="" id="optionFrom">From</option>
                            </select>
                            <span style="color: var(--text-light);" id="spanTo">to</span>
                            <select id="quizAyahTo">
                                <option value="" id="optionTo">To</option>
                            </select>
                        </div>
                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;" id="ayahRangeHint">
                            Leave blank to test all ayahs in the surah
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label id="labelDifficulty">Difficulty</label>
                        <select id="quizDifficulty">
                            <option value="1" id="optionEasy">Easy (1 missing word)</option>
                            <option value="2" id="optionMedium" selected>Medium (2 missing words)</option>
                            <option value="3" id="optionHard">Hard (3 missing words)</option>
                        </select>
                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;" id="difficultyHint">
                            Choose how many words will be missing from each verse
                        </small>
                    </div>
                    
                    <button onclick="startQuiz()" id="btnStartQuiz" style="width: 100%; padding: 2rem; font-size: 1.3rem; margin-top: 1rem;">
                        Start Quiz
                    </button>
                </div>

                <div id="quizContainer" style="display: none;"></div>

                <div id="quizResults" style="display: none;">
                    <div class="message">
                        <div style="font-size: 1.5rem; margin-bottom: 1rem;">Quiz Complete! üéâ</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Score: <span id="quizScore"></span></div>
                        <div style="font-size: 1rem; color: var(--text-light);">
                            <span id="quizVerseCount"></span> verses reviewed ‚úì
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button onclick="startQuiz()" style="flex: 1;">Take Another Quiz</button>
                        <button onclick="resetQuiz()" style="flex: 1; background: var(--accent);">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prayer Times Page -->
        <div id="pray" class="page">
            <div class="card">
                <h2 style="font-family: 'Amiri', serif; font-size: 1.6rem; margin-bottom: 1.25rem; color: var(--primary);">
                    Prayer Times - Cairo
                </h2>
                <div style="text-align: center; color: var(--text-light); margin-bottom: 1.5rem;">
                    <div id="hijriDate" style="font-size: 1rem; margin-bottom: 0.25rem;"></div>
                    <div id="gregorianDate" style="font-size: 0.9rem;"></div>
                </div>

                <div id="prayerTimesContainer" style="display: none;">
                    <div id="nextPrayerBanner" style="background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.25rem;">Next Prayer</div>
                        <div id="nextPrayerName" style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem;"></div>
                        <div id="nextPrayerTime" style="font-size: 1.8rem; font-weight: 700; font-family: 'Courier New', monospace;"></div>
                        <div id="timeRemaining" style="font-size: 0.95rem; margin-top: 0.5rem; opacity: 0.9;"></div>
                    </div>

                    <div style="display: grid; gap: 0.75rem;">
                        <div class="prayer-time-row" id="fajrRow">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">üåÖ</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">Fajr</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">ÿßŸÑŸÅÿ¨ÿ±</div>
                                </div>
                            </div>
                            <div id="fajrTime" style="font-size: 1.2rem; font-weight: 600; font-family: 'Courier New', monospace;"></div>
                        </div>

                        <div class="prayer-time-row" id="sunriseRow">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">‚òÄÔ∏è</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">Sunrise</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">ÿßŸÑÿ¥ÿ±ŸàŸÇ</div>
                                </div>
                            </div>
                            <div id="sunriseTime" style="font-size: 1.2rem; font-weight: 600; font-family: 'Courier New', monospace;"></div>
                        </div>

                        <div class="prayer-time-row" id="dhuhrRow">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">üåû</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">Dhuhr</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">ÿßŸÑÿ∏Ÿáÿ±</div>
                                </div>
                            </div>
                            <div id="dhuhrTime" style="font-size: 1.2rem; font-weight: 600; font-family: 'Courier New', monospace;"></div>
                        </div>

                        <div class="prayer-time-row" id="asrRow">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">üå§Ô∏è</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">Asr</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">ÿßŸÑÿπÿµÿ±</div>
                                </div>
                            </div>
                            <div id="asrTime" style="font-size: 1.2rem; font-weight: 600; font-family: 'Courier New', monospace;"></div>
                        </div>

                        <div class="prayer-time-row" id="maghribRow">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">üåá</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">Maghrib</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">ÿßŸÑŸÖÿ∫ÿ±ÿ®</div>
                                </div>
                            </div>
                            <div id="maghribTime" style="font-size: 1.2rem; font-weight: 600; font-family: 'Courier New', monospace;"></div>
                        </div>

                        <div class="prayer-time-row" id="ishaRow">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="font-size: 1.5rem;">üåô</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">Isha</div>
                                    <div style="font-size: 0.85rem; color: var(--text-light);">ÿßŸÑÿπÿ¥ÿßÿ°</div>
                                </div>
                            </div>
                            <div id="ishaTime" style="font-size: 1.2rem; font-weight: 600; font-family: 'Courier New', monospace;"></div>
                        </div>
                    </div>

                    <!-- Qibla Direction Section -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                        <h3 style="text-align: center; font-family: 'Amiri', serif; font-size: 1.3rem; color: var(--primary); margin-bottom: 1.5rem;">
                            Qibla Direction | ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÇÿ®ŸÑÿ©
                        </h3>
                        
                        <!-- Static Qibla Info -->
                        <div id="qiblaStatic">
                            <div style="position: relative; width: 280px; height: 280px; margin: 0 auto 1.5rem;">
                                <!-- Compass background -->
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #f5f5f5, #e0e0e0); box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);"></div>
                                
                                <!-- Cardinal directions -->
                                <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-weight: 700; font-size: 1.1rem; color: var(--error);">N</div>
                                <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-weight: 700; font-size: 1.1rem;">S</div>
                                <div style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-weight: 700; font-size: 1.1rem;">E</div>
                                <div style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); font-weight: 700; font-size: 1.1rem;">W</div>
                                
                                <!-- Compass needle (points to Qibla - 135¬∞ for Cairo) -->
                                <div style="position: absolute; top: 50%; left: 50%; width: 4px; height: 120px; background: linear-gradient(to bottom, var(--success) 0%, var(--success) 50%, #ccc 50%, #ccc 100%); transform-origin: 50% 50%; transform: translate(-50%, -50%) rotate(135deg); border-radius: 2px;"></div>
                                
                                <!-- Center dot -->
                                <div style="position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; background: white; border: 3px solid var(--primary); border-radius: 50%; transform: translate(-50%, -50%); z-index: 10;"></div>
                                
                                <!-- Kaaba icon at the Qibla direction -->
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) translateY(-75px) rotate(-135deg); font-size: 2rem;">üïã</div>
                            </div>
                            
                            <div style="text-align: center; background: var(--bg-light); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                                <div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.25rem;">Qibla Direction from Cairo</div>
                                <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary); font-family: 'Courier New', monospace;">135¬∞</div>
                                <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">Southeast Direction</div>
                            </div>
                            
                            <button onclick="startDeviceCompass()" style="width: 100%; background: var(--success); font-size: 1rem; padding: 0.85rem; margin-bottom: 1rem;">
                                üß≠ Use Device Compass
                            </button>
                            
                            <div style="padding: 1rem; background: rgba(46, 125, 50, 0.1); border-radius: 8px; border-left: 4px solid var(--success);">
                                <div style="font-size: 0.9rem; color: var(--text-primary);">
                                    üìç <strong>From Cairo to Makkah:</strong> The Qibla direction is approximately <strong>135¬∞ (Southeast)</strong>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                                    üí° Click "Use Device Compass" to align your device with the Qibla direction in real-time
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Device Compass -->
                        <div id="qiblaDeviceCompass" style="display: none;">
                            <!-- Big visual feedback at top -->
                            <div id="qiblaVisualFeedback" style="text-align: center; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; transition: all 0.3s ease; background: var(--bg-light);">
                                <div style="font-size: 4rem; margin-bottom: 0.5rem;" id="qiblaDirectionArrow">‚¨ÜÔ∏è</div>
                                <div style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem;" id="qiblaStatusText">Searching for North...</div>
                                <div style="font-size: 1rem; color: var(--text-light);" id="qiblaInstructionText">Hold device flat and move in figure-8</div>
                            </div>
                            
                            <!-- Compass display -->
                            <div style="position: relative; width: 280px; height: 280px; margin: 0 auto 1.5rem;">
                                <!-- Fixed compass background -->
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #f5f5f5, #e0e0e0); box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);">
                                    <!-- Cardinal directions (fixed) -->
                                    <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-weight: 700; font-size: 1.1rem; color: var(--error);">N</div>
                                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-weight: 700; font-size: 1.1rem;">S</div>
                                    <div style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-weight: 700; font-size: 1.1rem;">E</div>
                                    <div style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); font-weight: 700; font-size: 1.1rem;">W</div>
                                </div>
                                
                                <!-- Your current direction (red pointer - always points up) -->
                                <div style="position: absolute; top: 30px; left: 50%; width: 3px; height: 80px; background: var(--error); transform: translateX(-50%); border-radius: 2px; box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);"></div>
                                <div style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-size: 1.8rem;">üìç</div>
                                <div style="position: absolute; top: 110px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; font-weight: 700; color: var(--error); background: white; padding: 0.2rem 0.4rem; border-radius: 4px; white-space: nowrap;">You</div>
                                
                                <!-- Rotating Qibla arrow (shows where Qibla is) -->
                                <div class="qibla-arrow-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.2s ease-out;">
                                    <div style="width: 6px; height: 110px; background: var(--success); margin-left: -3px; margin-top: -55px; border-radius: 3px; box-shadow: 0 0 15px rgba(46, 125, 50, 0.7);"></div>
                                    <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 2.5rem;">üïã</div>
                                    <div style="position: absolute; top: 100px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; font-weight: 700; color: var(--success); background: white; padding: 0.2rem 0.4rem; border-radius: 4px; white-space: nowrap;">Qibla</div>
                                </div>
                                
                                <!-- Center dot -->
                                <div style="position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; background: white; border: 4px solid var(--primary); border-radius: 50%; transform: translate(-50%, -50%); z-index: 10;"></div>
                            </div>
                            
                            <!-- Technical details -->
                            <div style="text-align: center; background: var(--bg-light); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-around; align-items: center;">
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-light);">Your Heading</div>
                                        <div style="font-size: 1.4rem; font-weight: 700; color: var(--error); font-family: 'Courier New', monospace;" id="deviceHeading">0¬∞</div>
                                    </div>
                                    <div style="font-size: 2rem; color: var(--text-light);">‚Üí</div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-light);">Qibla Direction</div>
                                        <div style="font-size: 1.4rem; font-weight: 700; color: var(--success); font-family: 'Courier New', monospace;">135¬∞</div>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="stopDeviceCompass()" style="width: 100%; background: var(--error); font-size: 1rem; padding: 0.85rem; margin-bottom: 1rem;">
                                ‚èπ Stop Compass
                            </button>
                            
                            <div style="padding: 1rem; background: rgba(33, 150, 243, 0.1); border-radius: 8px; border-left: 4px solid #2196F3;">
                                <div style="font-size: 0.85rem; color: var(--text-primary); line-height: 1.5;">
                                    <strong>üìñ How to use:</strong><br>
                                    1Ô∏è‚É£ Hold phone <strong>flat</strong> (screen up)<br>
                                    2Ô∏è‚É£ Move in figure-8 to calibrate<br>
                                    3Ô∏è‚É£ Rotate your body until arrows <strong>align</strong><br>
                                    4Ô∏è‚É£ When both arrows point <strong>up</strong> ‚Üí You're facing Qibla! ‚úÖ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="prayerTimesLoading" style="text-align: center; padding: 2rem;">
                    <div class="loading">Loading prayer times...</div>
                </div>

                <div id="prayerTimesError" style="display: none; text-align: center; padding: 2rem; color: var(--error);">
                    Failed to load prayer times. Please check your connection.
                </div>
            </div>
        </div>
    </div>

    <script>
        // App State
        let currentUser = null;
        let deferredPrompt = null; // For PWA install prompt
        let quranData = [];
        let memorizedVerses = new Set();
        let reviewedVerses = new Set();
        let recitedPages = new Set(); // Tracks page numbers 1-604
        let bookmarkedVerses = new Set(); // Tracks bookmarked ayahs
        let currentVerse = null;
        let quizScore = 0;
        let quizTotal = 0;
        let filteredVerses = [];
        let currentVerseIndex = 0;
        let versesPerPage = 1;
        let currentQuizVerses = [];
        let currentQuizIndex = 0;
        let audioPlayer = null;
        let currentlyPlayingButton = null;
        let viewMode = 'surah'; // 'surah' or 'page'
        let language = 'en'; // 'en' or 'ar'
        let translationMode = 'english'; // 'english', 'arabic', or 'hide'
        let selectedReciter = 'ar.alafasy'; // default reciter
        
        // Translations
        const translations = {
            en: {
                // Navigation
                account: 'Account',
                memorize: 'Memorize/Recite',
                quiz: 'Quiz',
                pray: 'Pray',
                // Account page
                yourAccount: 'Your Account',
                welcome: 'Welcome',
                language: 'Language',
                totalMemorized: 'Total Verses Memorized/Recited',
                quranCompletion: 'Quran Completion',
                surahsCompleted: 'Surahs Completed',
                versesReviewed: 'Verses Reviewed',
                memorizationProgress: 'Memorization Progress',
                reviewProgress: 'Review Progress',
                recitationProgress: 'Recitation Progress',
                pagesRecited: 'Total Pages Recited',
                versesMemorized: 'Verses Memorized',
                completion: 'Completion',
                surahsDone: 'Surahs Done',
                quizButton: 'üìù Quiz',
                signOut: 'Sign Out',
                // Memorize page
                memorizationPractice: 'Memorization/Recitation Practice',
                viewMode: 'View Mode',
                bySurah: 'By Surah',
                byPage: 'By Page (Mushaf)',
                view: 'View',
                allVerses: 'All Verses',
                memorizedOnly: 'Memorized/Recited Only',
                notMemorized: 'Not Memorized/Recited',
                juz: 'Juz',
                allJuz: 'All Juz',
                surah: 'Surah',
                allSurahs: 'All Surahs',
                ayah: 'Ayah',
                allAyahs: 'All Ayahs',
                page: 'Page',
                selectPage: 'Select Page',
                perPage: 'Per Page',
                memorized: 'Memorized/Recited',
                bookmark: 'Bookmark',
                remove: 'Remove',
                filter: 'Filter:',
                all: 'All',
                next: 'Next',
                previous: 'Previous',
                markAll: 'Mark All as Memorized/Recited',
                verse: 'Verse',
                of: 'of',
                // Quiz page
                testMemory: 'Test Your Memory',
                selectSurah: 'Select Memorized/Recited Surah to Review',
                allMemorizedVerses: 'All Memorized/Recited Verses',
                ayahRange: 'Ayah Range',
                from: 'From',
                to: 'To',
                difficulty: 'Difficulty',
                easy: 'Easy (1 missing word)',
                medium: 'Medium (2 missing words)',
                hard: 'Hard (3 missing words)',
                startQuiz: 'Start Quiz',
                quizComplete: 'Quiz Complete!',
                score: 'Score',
                reviewed: 'reviewed',
                takeAnother: 'Take Another Quiz',
                close: 'Close'
            },
            ar: {
                // Navigation
                account: 'ÿßŸÑÿ≠ÿ≥ÿßÿ®',
                memorize: 'ÿßŸÑÿ≠ŸÅÿ∏/ÿßŸÑÿ™ŸÑÿßŸàÿ©',
                quiz: 'ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±',
                pray: 'ÿµŸÑŸêŸë',
                // Account page
                yourAccount: 'ÿ≠ÿ≥ÿßÿ®ŸÉ',
                welcome: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã',
                language: 'ÿßŸÑŸÑÿ∫ÿ©',
                totalMemorized: 'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©/ÿßŸÑŸÖÿ™ŸÑŸàÿ©',
                quranCompletion: 'ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑŸÇÿ±ÿ¢ŸÜ',
                surahsCompleted: 'ÿßŸÑÿ≥Ÿàÿ± ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ©',
                versesReviewed: 'ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',
                memorizationProgress: 'ÿ™ŸÇÿØŸÖ ÿßŸÑÿ≠ŸÅÿ∏',
                reviewProgress: 'ÿ™ŸÇÿØŸÖ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',
                recitationProgress: 'ÿ™ŸÇÿØŸÖ ÿßŸÑÿ™ŸÑÿßŸàÿ©',
                pagesRecited: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÖÿ™ŸÑŸàÿ©',
                versesMemorized: 'ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©',
                completion: 'ÿßŸÑÿ•ŸÉŸÖÿßŸÑ',
                surahsDone: 'ÿßŸÑÿ≥Ÿàÿ± ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ©',
                quizButton: 'üìù ÿßÿÆÿ™ÿ®ÿßÿ±',
                signOut: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
                // Memorize page
                memorizationPractice: 'ŸÖŸÖÿßÿ±ÿ≥ÿ© ÿßŸÑÿ≠ŸÅÿ∏/ÿßŸÑÿ™ŸÑÿßŸàÿ©',
                viewMode: 'Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂',
                bySurah: 'ÿ≠ÿ≥ÿ® ÿßŸÑÿ≥Ÿàÿ±ÿ©',
                byPage: 'ÿ≠ÿ≥ÿ® ÿßŸÑÿµŸÅÿ≠ÿ© (ÿßŸÑŸÖÿµÿ≠ŸÅ)',
                view: 'ÿßŸÑÿπÿ±ÿ∂',
                allVerses: 'ŸÉŸÑ ÿßŸÑÿ¢Ÿäÿßÿ™',
                memorizedOnly: 'ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©/ÿßŸÑŸÖÿ™ŸÑŸàÿ© ŸÅŸÇÿ∑',
                notMemorized: 'ÿ∫Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏ÿ©/ŸÖÿ™ŸÑŸàÿ©',
                juz: 'ÿßŸÑÿ¨ÿ≤ÿ°',
                allJuz: 'ŸÉŸÑ ÿßŸÑÿ£ÿ¨ÿ≤ÿßÿ°',
                surah: 'ÿßŸÑÿ≥Ÿàÿ±ÿ©',
                allSurahs: 'ŸÉŸÑ ÿßŸÑÿ≥Ÿàÿ±',
                ayah: 'ÿßŸÑÿ¢Ÿäÿ©',
                allAyahs: 'ŸÉŸÑ ÿßŸÑÿ¢Ÿäÿßÿ™',
                page: 'ÿßŸÑÿµŸÅÿ≠ÿ©',
                selectPage: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿµŸÅÿ≠ÿ©',
                perPage: 'ŸÑŸÉŸÑ ÿµŸÅÿ≠ÿ©',
                memorized: 'ŸÖÿ≠ŸÅŸàÿ∏ÿ©/ŸÖÿ™ŸÑŸàÿ©',
                bookmark: 'ÿ≠ŸÅÿ∏',
                remove: 'ÿ•ÿ≤ÿßŸÑÿ©',
                filter: 'ÿ™ÿµŸÅŸäÿ©:',
                all: 'ÿßŸÑŸÉŸÑ',
                next: 'ÿßŸÑÿ™ÿßŸÑŸä',
                previous: 'ÿßŸÑÿ≥ÿßÿ®ŸÇ',
                markAll: 'ÿ™ÿπŸÑŸäŸÖ ÿßŸÑŸÉŸÑ ŸÉŸÖÿ≠ŸÅŸàÿ∏/ŸÖÿ™ŸÑŸà',
                verse: 'ÿ¢Ÿäÿ©',
                of: 'ŸÖŸÜ',
                // Quiz page
                testMemory: 'ÿßÿÆÿ™ÿ®ÿ± ÿ≠ŸÅÿ∏ŸÉ',
                selectSurah: 'ÿßÿÆÿ™ÿ± ÿ≥Ÿàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©/ŸÖÿ™ŸÑŸàÿ© ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',
                allMemorizedVerses: 'ŸÉŸÑ ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©/ÿßŸÑŸÖÿ™ŸÑŸàÿ©',
                ayahRange: 'ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ¢Ÿäÿßÿ™',
                from: 'ŸÖŸÜ',
                to: 'ÿ•ŸÑŸâ',
                difficulty: 'ÿßŸÑÿµÿπŸàÿ®ÿ©',
                easy: 'ÿ≥ŸáŸÑ (ŸÉŸÑŸÖÿ© Ÿàÿßÿ≠ÿØÿ© ŸÖŸÅŸÇŸàÿØÿ©)',
                medium: 'ŸÖÿ™Ÿàÿ≥ÿ∑ (ŸÉŸÑŸÖÿ™ÿßŸÜ ŸÖŸÅŸÇŸàÿØÿ™ÿßŸÜ)',
                hard: 'ÿµÿπÿ® (Ÿ£ ŸÉŸÑŸÖÿßÿ™ ŸÖŸÅŸÇŸàÿØÿ©)',
                startQuiz: 'ÿßÿ®ÿØÿ£ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±',
                quizComplete: 'ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±!',
                score: 'ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©',
                reviewed: 'ŸÖÿ±ÿßÿ¨ÿπÿ©',
                takeAnother: 'ÿßÿÆÿ™ÿ®ÿßÿ± ÿ¢ÿÆÿ±',
                close: 'ÿ•ÿ∫ŸÑÿßŸÇ'
            }
        };
        
        function changeLanguage() {
            language = document.getElementById('languageSelector').value;
            localStorage.setItem('quran_language', language);
            
            // Update page direction
            document.body.dir = language === 'ar' ? 'rtl' : 'ltr';
            
            // Repopulate filters with new language
            populateFilters();
            
            // Update all UI text
            updateUILanguage();
        }
        
        function updateUILanguage() {
            const t = translations[language];
            
            // Navigation buttons
            document.querySelector('[data-page="account"]').textContent = t.account;
            document.querySelector('[data-page="memorize"]').textContent = t.memorize;
            const prayBtn = document.querySelector('[data-page="pray"]');
            if (prayBtn) prayBtn.textContent = t.pray;
            
            // Account page
            const accountH2 = document.querySelector('#account h2');
            if (accountH2) accountH2.textContent = t.yourAccount;
            
            // Account stat labels with IDs
            const labelPagesRecited = document.getElementById('labelPagesRecited');
            if (labelPagesRecited) labelPagesRecited.textContent = t.pagesRecited;
            
            const labelRecitationProgress = document.getElementById('labelRecitationProgress');
            if (labelRecitationProgress) labelRecitationProgress.textContent = t.recitationProgress;
            
            const labelTotalVerses = document.getElementById('labelTotalVerses');
            if (labelTotalVerses) labelTotalVerses.textContent = t.versesMemorized;
            
            const labelCompletion = document.getElementById('labelCompletion');
            if (labelCompletion) labelCompletion.textContent = t.completion;
            
            const labelSurahsDone = document.getElementById('labelSurahsDone');
            if (labelSurahsDone) labelSurahsDone.textContent = t.surahsDone;
            
            const labelMemorizationProgress = document.getElementById('labelMemorizationProgress');
            if (labelMemorizationProgress) labelMemorizationProgress.textContent = t.memorizationProgress;
            
            const btnQuiz = document.getElementById('btnQuiz');
            if (btnQuiz) btnQuiz.textContent = t.quizButton;
            
            // Sign out button
            const signOutBtn = document.querySelector('#accountDashboard button[onclick="logout()"]');
            if (signOutBtn) signOutBtn.textContent = t.signOut;
            
            // Memorize page
            const memorizeH2 = document.querySelector('#memorize h2');
            if (memorizeH2) memorizeH2.textContent = t.memorizationPractice;
            
            // Filter label
            const labelFilter = document.getElementById('labelFilter');
            if (labelFilter) labelFilter.textContent = t.filter;
            
            // Update viewFilter options
            const viewFilterSelect = document.getElementById('viewFilter');
            if (viewFilterSelect && viewFilterSelect.options) {
                viewFilterSelect.options[0].textContent = t.all;
                viewFilterSelect.options[1].textContent = t.memorizedOnly;
                viewFilterSelect.options[2].textContent = t.notMemorized;
            }
            
            // Update all "Memorized" labels in verse cards
            document.querySelectorAll('.memorized-toggle span').forEach(span => {
                if (span.textContent === 'Memorized' || span.textContent === 'ŸÖÿ≠ŸÅŸàÿ∏ÿ©/ŸÖÿ™ŸÑŸàÿ©') {
                    span.textContent = t.memorized;
                }
            });
            
            // Update all "Bookmark" buttons
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                if (btn.textContent === 'Bookmark' || btn.textContent === 'ÿ≠ŸÅÿ∏') {
                    btn.textContent = t.bookmark;
                } else if (btn.textContent === '‚úì Saved' || btn.textContent === '‚úì ŸÖÿ≠ŸÅŸàÿ∏') {
                    btn.textContent = '‚úì ' + t.bookmark;
                }
            });
            
            // Memorize filters
            const labelViewMode = document.getElementById('labelViewMode');
            if (labelViewMode) labelViewMode.textContent = t.viewMode;
            
            const optionBySurah = document.getElementById('optionBySurah');
            if (optionBySurah) optionBySurah.textContent = t.bySurah;
            
            const optionByPage = document.getElementById('optionByPage');
            if (optionByPage) optionByPage.textContent = t.byPage;
            
            const labelView = document.getElementById('labelView');
            if (labelView) labelView.textContent = t.view;
            
            const optionAllVerses = document.getElementById('optionAllVerses');
            if (optionAllVerses) optionAllVerses.textContent = t.allVerses;
            
            const optionMemorizedOnly = document.getElementById('optionMemorizedOnly');
            if (optionMemorizedOnly) optionMemorizedOnly.textContent = t.memorizedOnly;
            
            const optionNotMemorized = document.getElementById('optionNotMemorized');
            if (optionNotMemorized) optionNotMemorized.textContent = t.notMemorized;
            
            const labelJuz = document.getElementById('labelJuz');
            if (labelJuz) labelJuz.textContent = t.juz;
            
            const optionAllJuz = document.getElementById('optionAllJuz');
            if (optionAllJuz) optionAllJuz.textContent = t.allJuz;
            
            const labelSurah = document.getElementById('labelSurah');
            if (labelSurah) labelSurah.textContent = t.surah;
            
            const optionAllSurahs = document.getElementById('optionAllSurahs');
            if (optionAllSurahs) optionAllSurahs.textContent = t.allSurahs;
            
            const labelAyah = document.getElementById('labelAyah');
            if (labelAyah) labelAyah.textContent = t.ayah;
            
            const optionAllAyahs = document.getElementById('optionAllAyahs');
            if (optionAllAyahs) optionAllAyahs.textContent = t.allAyahs;
            
            const labelPage = document.getElementById('labelPage');
            if (labelPage) labelPage.textContent = t.page;
            
            const optionSelectPage = document.getElementById('optionSelectPage');
            if (optionSelectPage) optionSelectPage.textContent = t.selectPage;
            
            const labelPerPage = document.getElementById('labelPerPage');
            if (labelPerPage) labelPerPage.textContent = t.perPage;
            
            const optionAll = document.getElementById('optionAll');
            if (optionAll) optionAll.textContent = t.allVerses;
            
            // Quiz page
            const quizH2 = document.querySelector('#quiz h2');
            if (quizH2) quizH2.textContent = t.testMemory;
            
            const labelSelectSurah = document.getElementById('labelSelectSurah');
            if (labelSelectSurah) labelSelectSurah.textContent = t.selectSurah;
            
            const optionAllMemorized = document.getElementById('optionAllMemorized');
            if (optionAllMemorized) optionAllMemorized.textContent = t.allMemorizedVerses;
            
            const labelAyahRange = document.getElementById('labelAyahRange');
            if (labelAyahRange) labelAyahRange.textContent = t.ayahRange;
            
            const optionFrom = document.getElementById('optionFrom');
            if (optionFrom) optionFrom.textContent = t.from;
            
            const spanTo = document.getElementById('spanTo');
            if (spanTo) spanTo.textContent = t.to;
            
            const optionTo = document.getElementById('optionTo');
            if (optionTo) optionTo.textContent = t.to;
            
            const labelDifficulty = document.getElementById('labelDifficulty');
            if (labelDifficulty) labelDifficulty.textContent = t.difficulty;
            
            const optionEasy = document.getElementById('optionEasy');
            if (optionEasy) optionEasy.textContent = t.easy;
            
            const optionMedium = document.getElementById('optionMedium');
            if (optionMedium) optionMedium.textContent = t.medium;
            
            const optionHard = document.getElementById('optionHard');
            if (optionHard) optionHard.textContent = t.hard;
            
            const difficultyHint = document.getElementById('difficultyHint');
            if (difficultyHint && language === 'ar') {
                difficultyHint.textContent = 'ÿßÿÆÿ™ÿ± ÿπÿØÿØ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖŸÅŸÇŸàÿØÿ© ŸÖŸÜ ŸÉŸÑ ÿ¢Ÿäÿ©';
            } else if (difficultyHint) {
                difficultyHint.textContent = 'Choose how many words will be missing from each verse';
            }
            
            const btnStartQuiz = document.getElementById('btnStartQuiz');
            if (btnStartQuiz) btnStartQuiz.textContent = t.startQuiz;
            
            const ayahRangeHint = document.getElementById('ayahRangeHint');
            if (ayahRangeHint && language === 'ar') {
                ayahRangeHint.textContent = 'ÿßÿ™ÿ±ŸÉ ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¢Ÿäÿßÿ™ ŸÅŸä ÿßŸÑÿ≥Ÿàÿ±ÿ©';
            } else if (ayahRangeHint) {
                ayahRangeHint.textContent = 'Leave blank to test all ayahs in the surah';
            }
            
            // Refresh current display
            if (filteredVerses.length > 0) {
                displayVerseWithNavigation(currentVerseIndex);
            }
        }
        
        // OTP verification state
        let pendingEmail = null;
        let generatedOTP = null;
        let otpExpiry = null;

        // OTP Functions
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        async function sendOTP() {
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();
            const sendBtn = document.getElementById('sendOtpBtn');
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (email.indexOf('@') === -1 || email.indexOf('.') === -1) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Disable button and show loading
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            try {
                // Generate OTP
                generatedOTP = generateOTP();
                pendingEmail = email;
                otpExpiry = Date.now() + (5 * 60 * 1000); // 5 minutes
                
                console.log('Sending OTP to:', email);
                console.log('OTP Code:', generatedOTP);
                
                // Send email via backend API
                const response = await fetch('https://quran-memorization-app-1.onrender.com/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        otp: generatedOTP
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to send email');
                }
                
                console.log('Email sent successfully!');
                
                // Switch to OTP input view
                document.getElementById('emailStep').style.display = 'none';
                document.getElementById('otpStep').style.display = 'block';
                document.getElementById('otpEmailDisplay').textContent = email;
                
                // Start countdown timer
                startOTPTimer();
                
                // Focus on OTP input
                setTimeout(() => {
                    document.getElementById('otpInput').focus();
                }, 100);
                
            } catch (error) {
                console.error('Failed to send email:', error);
                alert('Failed to send verification code. Please try again.\n\nError: ' + error.message);
                
                // Reset state
                generatedOTP = null;
                pendingEmail = null;
                otpExpiry = null;
            } finally {
                // Re-enable button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Verification Code';
            }
        }
        
        function startOTPTimer() {
            const timerDisplay = document.getElementById('otpTimer');
            
            const updateTimer = () => {
                const remaining = otpExpiry - Date.now();
                
                if (remaining <= 0) {
                    timerDisplay.textContent = '0:00';
                    timerDisplay.style.color = 'var(--error)';
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                setTimeout(updateTimer, 1000);
            };
            
            updateTimer();
        }
        
        function verifyOTP() {
            const otpInput = document.getElementById('otpInput');
            const enteredOTP = otpInput.value.trim();
            
            if (!enteredOTP) {
                alert('Please enter the verification code');
                return;
            }
            
            if (enteredOTP.length !== 6) {
                alert('Please enter the complete 6-digit code');
                return;
            }
            
            // Check if OTP expired
            if (Date.now() > otpExpiry) {
                alert('Verification code has expired. Please request a new one.');
                return;
            }
            
            // Verify OTP
            if (enteredOTP !== generatedOTP) {
                alert('Invalid verification code. Please try again.');
                otpInput.value = '';
                otpInput.focus();
                return;
            }
            
            // OTP verified successfully - proceed with login
            console.log('OTP verified successfully for:', pendingEmail);
            completeLogin(pendingEmail);
        }
        
        async function resendOTP() {
            if (!pendingEmail) {
                alert('Error: No email found. Please start over.');
                resetToEmailStep();
                return;
            }
            
            const resendBtn = document.getElementById('resendOtpBtn');
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            
            try {
                // Generate new OTP
                generatedOTP = generateOTP();
                otpExpiry = Date.now() + (5 * 60 * 1000);
                
                console.log('Resending OTP to:', pendingEmail);
                console.log('New OTP Code:', generatedOTP);
                
                // Send email via backend API
                const response = await fetch('https://quran-memorization-app-1.onrender.com/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: pendingEmail,
                        otp: generatedOTP
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to send email');
                }
                
                console.log('Email resent successfully!');
                alert('New verification code sent!');
                
                // Clear input and restart timer
                document.getElementById('otpInput').value = '';
                startOTPTimer();
                
            } catch (error) {
                console.error('Failed to resend email:', error);
                alert('Failed to resend code. Please try again.\n\nError: ' + error.message);
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend Code';
            }
        }
        
        function resetToEmailStep() {
            document.getElementById('emailStep').style.display = 'block';
            document.getElementById('otpStep').style.display = 'none';
            document.getElementById('otpInput').value = '';
            pendingEmail = null;
            generatedOTP = null;
            otpExpiry = null;
        }
        
        function completeLogin(email) {
            try {
                currentUser = email;
                
                const loginForm = document.getElementById('loginForm');
                const dashboard = document.getElementById('accountDashboard');
                const welcome = document.getElementById('welcomeMessage');
                
                if (!loginForm || !dashboard || !welcome) {
                    alert('Error: Page elements missing. Please refresh.');
                    return;
                }
                
                loginForm.style.display = 'none';
                dashboard.style.display = 'block';
                welcome.textContent = 'Welcome, ' + email + '!';
                
                loadUserData();
                updateAccountStats();
                
                try {
                    localStorage.setItem('quran_user', email);
                } catch (e) {
                    console.log('localStorage not available:', e);
                }
                
                // Reset OTP state
                pendingEmail = null;
                generatedOTP = null;
                otpExpiry = null;
                
                // Reset form for next time
                resetToEmailStep();
                document.getElementById('email').value = '';
                
            } catch (error) {
                alert('Login error: ' + error.message);
                console.error('Login error:', error);
            }
        }

        // Simple wrapper for login
        function handleLogin() {
            try {
                const emailInput = document.getElementById('email');
                
                if (!emailInput) {
                    alert('Error: Cannot find email input. Please refresh the page.');
                    return;
                }
                
                const email = emailInput.value.trim();
                
                if (!email) {
                    alert('Please enter an email address');
                    return;
                }
                
                if (email.indexOf('@') === -1) {
                    alert('Please enter a valid email with @');
                    return;
                }
                
                currentUser = email;
                
                const loginForm = document.getElementById('loginForm');
                const dashboard = document.getElementById('accountDashboard');
                const welcome = document.getElementById('welcomeMessage');
                
                if (!loginForm || !dashboard || !welcome) {
                    alert('Error: Page elements missing. Please refresh.');
                    return;
                }
                
                loginForm.style.display = 'none';
                dashboard.style.display = 'block';
                welcome.textContent = 'Welcome, ' + email + '!';
                
                loadUserData();
                updateAccountStats();
                
                try {
                    localStorage.setItem('quran_user', email);
                } catch (e) {
                    console.log('localStorage not available:', e);
                }
                
            } catch (error) {
                alert('Login error: ' + error.message);
                console.error('Login error:', error);
            }
        }

        // Initialize App
        // Keep backend alive (prevent Render free tier from sleeping)
        function keepBackendAlive() {
            const BACKEND_URL = 'https://quran-memorization-app-1.onrender.com';
            const PING_INTERVAL = 14 * 60 * 1000; // 14 minutes in milliseconds
            
            async function ping() {
                try {
                    const response = await fetch(`${BACKEND_URL}/health`);
                    if (response.ok) {
                        console.log('‚úì Backend keep-alive ping successful');
                    }
                } catch (error) {
                    console.log('Backend ping failed (might be sleeping):', error.message);
                }
            }
            
            // Initial ping after 1 minute
            setTimeout(ping, 60000);
            
            // Then ping every 14 minutes
            setInterval(ping, PING_INTERVAL);
            
            console.log('Keep-alive mechanism started (ping every 14 minutes)');
        }

        async function initApp() {
            console.log('=== INITIALIZING APP ===');
            
            // Check for app updates (PWA cache busting)
            const APP_VERSION = '2.1.0'; // Increment this when pushing updates
            const savedVersion = localStorage.getItem('app_version');
            if (savedVersion !== APP_VERSION) {
                console.log('New version detected, clearing cache...');
                localStorage.setItem('app_version', APP_VERSION);
                // Force reload from server
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
            }
            
            // Load saved language
            const savedLang = localStorage.getItem('quran_language');
            if (savedLang) {
                language = savedLang;
                const langSelector = document.getElementById('languageSelector');
                if (langSelector) {
                    // Set value without triggering onchange
                    const currentOnChange = langSelector.onchange;
                    langSelector.onchange = null;
                    langSelector.value = savedLang;
                    langSelector.onchange = currentOnChange;
                }
                document.body.dir = language === 'ar' ? 'rtl' : 'ltr';
            }
            
            // Load saved translation preference
            const savedTranslation = localStorage.getItem('quran_translation_mode');
            if (savedTranslation) {
                translationMode = savedTranslation;
                document.getElementById('showTranslation').value = savedTranslation;
            }
            
            // Load saved reciter preference
            const savedReciter = localStorage.getItem('quran_reciter');
            if (savedReciter) {
                selectedReciter = savedReciter;
                document.getElementById('reciterSelector').value = savedReciter;
            }
            
            await loadQuranData();
            populateFilters();
            await checkSavedUser(); // Wait for user data to load
            updateUILanguage();
            
            // Load only Al-Fatihah by default (filters show "All" but display is Fatihah)
            filteredVerses = quranData.filter(v => v.surah === 1);
            versesPerPage = filteredVerses.length;
            currentVerseIndex = 0;
            if (filteredVerses.length > 0) {
                displayVerseWithNavigation(0);
            }
            
            // Start keep-alive mechanism
            keepBackendAlive();
            
            console.log('=== APP INITIALIZED ===');
        }

        // Load Quran Data from API
        async function loadQuranData() {
            const container = document.getElementById('verseDisplay');
            container.innerHTML = '<div class="loading">Loading Quran data... (Step 1/2: Arabic text)</div>';
            
            try {
                // Using quran-uthmani which includes page numbers
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                if (result.code !== 200 || !result.data) {
                    throw new Error('Failed to fetch Quran data');
                }
                
                const quranResponse = result.data;
                
                // Transform data to match our structure
                quranData = [];
                quranResponse.surahs.forEach(surah => {
                    surah.ayahs.forEach(ayah => {
                        quranData.push({
                            surah: surah.number,
                            ayah: ayah.numberInSurah,
                            juz: ayah.juz,
                            page: ayah.page || 1,
                            arab: ayah.text,
                            translation: '' // We'll add translation separately
                        });
                    });
                });
                
                console.log('Quran data loaded:', quranData.length, 'verses');
                console.log('Sample verse with page:', quranData[0]);
                console.log('Page numbers range:', Math.min(...quranData.map(v => v.page)), '-', Math.max(...quranData.map(v => v.page)));
                
                // Update loading message
                container.innerHTML = '<div class="loading">Loading translations... (Step 2/3)</div>';
                
                // Load English translation
                const transController = new AbortController();
                const transTimeoutId = setTimeout(() => transController.abort(), 30000);
                
                const translationResponse = await fetch('https://api.alquran.cloud/v1/quran/en.asad', {
                    signal: transController.signal
                });
                clearTimeout(transTimeoutId);
                
                const translationResult = await translationResponse.json();
                
                if (translationResult.code === 200 && translationResult.data) {
                    let verseIndex = 0;
                    translationResult.data.surahs.forEach(surah => {
                        surah.ayahs.forEach(ayah => {
                            if (quranData[verseIndex]) {
                                quranData[verseIndex].translation = ayah.text;
                            }
                            verseIndex++;
                        });
                    });
                }
                
                console.log('English translations loaded');
                
                // Load Arabic tafseer (Tafsir Al-Muyassar)
                container.innerHTML = '<div class="loading">Loading Arabic meanings... (Step 3/3)</div>';
                
                const tafseerController = new AbortController();
                const tafseerTimeoutId = setTimeout(() => tafseerController.abort(), 30000);
                
                const tafseerResponse = await fetch('https://api.alquran.cloud/v1/quran/ar.muyassar', {
                    signal: tafseerController.signal
                });
                clearTimeout(tafseerTimeoutId);
                
                const tafseerResult = await tafseerResponse.json();
                
                if (tafseerResult.code === 200 && tafseerResult.data) {
                    let verseIndex = 0;
                    tafseerResult.data.surahs.forEach(surah => {
                        surah.ayahs.forEach(ayah => {
                            if (quranData[verseIndex]) {
                                quranData[verseIndex].tafseer = ayah.text;
                            }
                            verseIndex++;
                        });
                    });
                }
                
                console.log('Arabic tafseer loaded');
                console.log('Sample verse with all data:', quranData[0]);
                
                // Auto-load all verses by default
                filteredVerses = [...quranData];
                currentVerseIndex = 0;
                displayVerseWithNavigation(0);
                
            } catch (error) {
                console.error('Error loading Quran data:', error);
                
                if (error.name === 'AbortError') {
                    container.innerHTML = `<div class="loading" style="color: var(--error);">Loading timeout. Your connection might be slow.<br><br><button onclick="location.reload()" style="background: var(--secondary);">Retry</button></div>`;
                } else {
                    container.innerHTML = `<div class="loading" style="color: var(--error);">Failed to load: ${error.message}<br><br><button onclick="location.reload()" style="background: var(--secondary);">Retry</button></div>`;
                }
            }
        }

        // Populate Filter Dropdowns
        const surahNames = {
            1: "Al-Fatihah", 2: "Al-Baqarah", 3: "Ali 'Imran", 4: "An-Nisa", 
            5: "Al-Ma'idah", 6: "Al-An'am", 7: "Al-A'raf", 8: "Al-Anfal",
            9: "At-Tawbah", 10: "Yunus", 11: "Hud", 12: "Yusuf",
            13: "Ar-Ra'd", 14: "Ibrahim", 15: "Al-Hijr", 16: "An-Nahl",
            17: "Al-Isra", 18: "Al-Kahf", 19: "Maryam", 20: "Ta-Ha",
            21: "Al-Anbya", 22: "Al-Hajj", 23: "Al-Mu'minun", 24: "An-Nur",
            25: "Al-Furqan", 26: "Ash-Shu'ara", 27: "An-Naml", 28: "Al-Qasas",
            29: "Al-'Ankabut", 30: "Ar-Rum", 31: "Luqman", 32: "As-Sajdah",
            33: "Al-Ahzab", 34: "Saba", 35: "Fatir", 36: "Ya-Sin",
            37: "As-Saffat", 38: "Sad", 39: "Az-Zumar", 40: "Ghafir",
            41: "Fussilat", 42: "Ash-Shuraa", 43: "Az-Zukhruf", 44: "Ad-Dukhan",
            45: "Al-Jathiyah", 46: "Al-Ahqaf", 47: "Muhammad", 48: "Al-Fath",
            49: "Al-Hujurat", 50: "Qaf", 51: "Adh-Dhariyat", 52: "At-Tur",
            53: "An-Najm", 54: "Al-Qamar", 55: "Ar-Rahman", 56: "Al-Waqi'ah",
            57: "Al-Hadid", 58: "Al-Mujadila", 59: "Al-Hashr", 60: "Al-Mumtahanah",
            61: "As-Saf", 62: "Al-Jumu'ah", 63: "Al-Munafiqun", 64: "At-Taghabun",
            65: "At-Talaq", 66: "At-Tahrim", 67: "Al-Mulk", 68: "Al-Qalam",
            69: "Al-Haqqah", 70: "Al-Ma'arij", 71: "Nuh", 72: "Al-Jinn",
            73: "Al-Muzzammil", 74: "Al-Muddaththir", 75: "Al-Qiyamah", 76: "Al-Insan",
            77: "Al-Mursalat", 78: "An-Naba", 79: "An-Nazi'at", 80: "'Abasa",
            81: "At-Takwir", 82: "Al-Infitar", 83: "Al-Mutaffifin", 84: "Al-Inshiqaq",
            85: "Al-Buruj", 86: "At-Tariq", 87: "Al-A'la", 88: "Al-Ghashiyah",
            89: "Al-Fajr", 90: "Al-Balad", 91: "Ash-Shams", 92: "Al-Layl",
            93: "Ad-Duhaa", 94: "Ash-Sharh", 95: "At-Tin", 96: "Al-'Alaq",
            97: "Al-Qadr", 98: "Al-Bayyinah", 99: "Az-Zalzalah", 100: "Al-'Adiyat",
            101: "Al-Qari'ah", 102: "At-Takathur", 103: "Al-'Asr", 104: "Al-Humazah",
            105: "Al-Fil", 106: "Quraysh", 107: "Al-Ma'un", 108: "Al-Kawthar",
            109: "Al-Kafirun", 110: "An-Nasr", 111: "Al-Masad", 112: "Al-Ikhlas",
            113: "Al-Falaq", 114: "An-Nas"
        };
        
        const surahNamesArabic = {
            1: "ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©", 2: "ÿßŸÑÿ®ŸÇÿ±ÿ©", 3: "ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ", 4: "ÿßŸÑŸÜÿ≥ÿßÿ°",
            5: "ÿßŸÑŸÖÿßÿ¶ÿØÿ©", 6: "ÿßŸÑÿ£ŸÜÿπÿßŸÖ", 7: "ÿßŸÑÿ£ÿπÿ±ÿßŸÅ", 8: "ÿßŸÑÿ£ŸÜŸÅÿßŸÑ",
            9: "ÿßŸÑÿ™Ÿàÿ®ÿ©", 10: "ŸäŸàŸÜÿ≥", 11: "ŸáŸàÿØ", 12: "ŸäŸàÿ≥ŸÅ",
            13: "ÿßŸÑÿ±ÿπÿØ", 14: "ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ", 15: "ÿßŸÑÿ≠ÿ¨ÿ±", 16: "ÿßŸÑŸÜÿ≠ŸÑ",
            17: "ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°", 18: "ÿßŸÑŸÉŸáŸÅ", 19: "ŸÖÿ±ŸäŸÖ", 20: "ÿ∑Ÿá",
            21: "ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°", 22: "ÿßŸÑÿ≠ÿ¨", 23: "ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ", 24: "ÿßŸÑŸÜŸàÿ±",
            25: "ÿßŸÑŸÅÿ±ŸÇÿßŸÜ", 26: "ÿßŸÑÿ¥ÿπÿ±ÿßÿ°", 27: "ÿßŸÑŸÜŸÖŸÑ", 28: "ÿßŸÑŸÇÿµÿµ",
            29: "ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™", 30: "ÿßŸÑÿ±ŸàŸÖ", 31: "ŸÑŸÇŸÖÿßŸÜ", 32: "ÿßŸÑÿ≥ÿ¨ÿØÿ©",
            33: "ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®", 34: "ÿ≥ÿ®ÿ£", 35: "ŸÅÿßÿ∑ÿ±", 36: "Ÿäÿ≥",
            37: "ÿßŸÑÿµÿßŸÅÿßÿ™", 38: "ÿµ", 39: "ÿßŸÑÿ≤ŸÖÿ±", 40: "ÿ∫ÿßŸÅÿ±",
            41: "ŸÅÿµŸÑÿ™", 42: "ÿßŸÑÿ¥Ÿàÿ±Ÿâ", 43: "ÿßŸÑÿ≤ÿÆÿ±ŸÅ", 44: "ÿßŸÑÿØÿÆÿßŸÜ",
            45: "ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©", 46: "ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ", 47: "ŸÖÿ≠ŸÖÿØ", 48: "ÿßŸÑŸÅÿ™ÿ≠",
            49: "ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™", 50: "ŸÇ", 51: "ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™", 52: "ÿßŸÑÿ∑Ÿàÿ±",
            53: "ÿßŸÑŸÜÿ¨ŸÖ", 54: "ÿßŸÑŸÇŸÖÿ±", 55: "ÿßŸÑÿ±ÿ≠ŸÖŸÜ", 56: "ÿßŸÑŸàÿßŸÇÿπÿ©",
            57: "ÿßŸÑÿ≠ÿØŸäÿØ", 58: "ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©", 59: "ÿßŸÑÿ≠ÿ¥ÿ±", 60: "ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©",
            61: "ÿßŸÑÿµŸÅ", 62: "ÿßŸÑÿ¨ŸÖÿπÿ©", 63: "ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ", 64: "ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ",
            65: "ÿßŸÑÿ∑ŸÑÿßŸÇ", 66: "ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ", 67: "ÿßŸÑŸÖŸÑŸÉ", 68: "ÿßŸÑŸÇŸÑŸÖ",
            69: "ÿßŸÑÿ≠ÿßŸÇÿ©", 70: "ÿßŸÑŸÖÿπÿßÿ±ÿ¨", 71: "ŸÜŸàÿ≠", 72: "ÿßŸÑÿ¨ŸÜ",
            73: "ÿßŸÑŸÖÿ≤ŸÖŸÑ", 74: "ÿßŸÑŸÖÿØÿ´ÿ±", 75: "ÿßŸÑŸÇŸäÿßŸÖÿ©", 76: "ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ",
            77: "ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™", 78: "ÿßŸÑŸÜÿ®ÿ£", 79: "ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™", 80: "ÿπÿ®ÿ≥",
            81: "ÿßŸÑÿ™ŸÉŸàŸäÿ±", 82: "ÿßŸÑÿ•ŸÜŸÅÿ∑ÿßÿ±", 83: "ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ", 84: "ÿßŸÑÿ•ŸÜÿ¥ŸÇÿßŸÇ",
            85: "ÿßŸÑÿ®ÿ±Ÿàÿ¨", 86: "ÿßŸÑÿ∑ÿßÿ±ŸÇ", 87: "ÿßŸÑÿ£ÿπŸÑŸâ", 88: "ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©",
            89: "ÿßŸÑŸÅÿ¨ÿ±", 90: "ÿßŸÑÿ®ŸÑÿØ", 91: "ÿßŸÑÿ¥ŸÖÿ≥", 92: "ÿßŸÑŸÑŸäŸÑ",
            93: "ÿßŸÑÿ∂ÿ≠Ÿâ", 94: "ÿßŸÑÿ¥ÿ±ÿ≠", 95: "ÿßŸÑÿ™ŸäŸÜ", 96: "ÿßŸÑÿπŸÑŸÇ",
            97: "ÿßŸÑŸÇÿØÿ±", 98: "ÿßŸÑÿ®ŸäŸÜÿ©", 99: "ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©", 100: "ÿßŸÑÿπÿßÿØŸäÿßÿ™",
            101: "ÿßŸÑŸÇÿßÿ±ÿπÿ©", 102: "ÿßŸÑÿ™ŸÉÿßÿ´ÿ±", 103: "ÿßŸÑÿπÿµÿ±", 104: "ÿßŸÑŸáŸÖÿ≤ÿ©",
            105: "ÿßŸÑŸÅŸäŸÑ", 106: "ŸÇÿ±Ÿäÿ¥", 107: "ÿßŸÑŸÖÿßÿπŸàŸÜ", 108: "ÿßŸÑŸÉŸàÿ´ÿ±",
            109: "ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ", 110: "ÿßŸÑŸÜÿµÿ±", 111: "ÿßŸÑŸÖÿ≥ÿØ", 112: "ÿßŸÑÿ•ÿÆŸÑÿßÿµ",
            113: "ÿßŸÑŸÅŸÑŸÇ", 114: "ÿßŸÑŸÜÿßÿ≥"
        };
        
        // Helper function to get surah name based on language
        function getSurahName(surahNum) {
            return language === 'ar' ? surahNamesArabic[surahNum] : surahNames[surahNum];
        }
        
        function populateSurahsByJuz(juzNumber) {
            const surahFilter = document.getElementById('surahFilter');
            const allSurahsText = language === 'ar' ? 'ŸÉŸÑ ÿßŸÑÿ≥Ÿàÿ±' : 'All Surahs';
            surahFilter.innerHTML = `<option value="">${allSurahsText}</option>`;
            
            if (!juzNumber) {
                // Show all surahs
                for (let i = 1; i <= 114; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}. ${getSurahName(i)}`;
                    surahFilter.appendChild(option);
                }
            } else {
                // Get unique surahs in this juz
                const surahsInJuz = [...new Set(
                    quranData
                        .filter(v => v.juz === parseInt(juzNumber))
                        .map(v => v.surah)
                )].sort((a, b) => a - b);
                
                surahsInJuz.forEach(surahNum => {
                    const option = document.createElement('option');
                    option.value = surahNum;
                    option.textContent = `${surahNum}. ${getSurahName(surahNum)}`;
                    surahFilter.appendChild(option);
                });
            }
        }

        function populateFilters() {
            // Populate Juz (1-30)
            const juzFilter = document.getElementById('juzFilter');
            juzFilter.innerHTML = '<option value="" id="optionAllJuz">All Juz</option>'; // Clear and add default
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = language === 'ar' ? `ÿßŸÑÿ¨ÿ≤ÿ° ${i}` : `Juz ${i}`;
                juzFilter.appendChild(option);
            }
            
            // Leave juz filter at "All Juz" (no default selection)

            // Populate all surahs
            populateSurahsByJuz(null);
            
            // Leave surah filter at "All Surahs" (no default selection)
            
            // Populate Pages (1-604)
            const pageFilter = document.getElementById('pageFilter');
            pageFilter.innerHTML = '<option value="" id="optionSelectPage">Select Page</option>'; // Clear and add default
            for (let i = 1; i <= 604; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = language === 'ar' ? `ÿµŸÅÿ≠ÿ© ${i}` : `Page ${i}`;
                pageFilter.appendChild(option);
            }
        }

        function toggleTranslationDisplay() {
            const value = document.getElementById('showTranslation').value;
            translationMode = value; // 'english', 'arabic', or 'hide'
            
            // Save to localStorage
            localStorage.setItem('quran_translation_mode', value);
            
            // Refresh display
            if (filteredVerses.length > 0) {
                displayVerseWithNavigation(currentVerseIndex);
            }
        }
        
        function changePageTranslation() {
            const value = document.getElementById('pageTranslationMode').value;
            translationMode = value;
            
            // Save to localStorage
            localStorage.setItem('quran_translation_mode', value);
            
            // Update main account translation dropdown to match
            const mainTranslation = document.getElementById('showTranslation');
            if (mainTranslation) {
                mainTranslation.value = value;
            }
            
            // Refresh display
            if (filteredVerses.length > 0) {
                displayVerseWithNavigation(currentVerseIndex);
            }
        }
        
        function changeReciter() {
            const reciter = document.getElementById('reciterSelector').value;
            selectedReciter = reciter;
            
            // Save to database and localStorage
            if (currentUser) {
                saveUserData();
            }
            localStorage.setItem('quran_reciter', reciter);
            
            console.log('Reciter changed to:', reciter);
        }

        function switchViewMode() {
            viewMode = document.getElementById('viewModeFilter').value;
            
            if (viewMode === 'page') {
                // Hide surah/juz/ayah filters and memorize filter, show page filter
                document.getElementById('juzFilterGroup').style.display = 'none';
                document.getElementById('surahFilterGroup').style.display = 'none';
                document.getElementById('ayahFilterGroup').style.display = 'none';
                document.getElementById('memorizeFilterContainer').style.display = 'none';
                document.getElementById('pageFilterGroup').style.display = 'block';
                
                // Auto-select page 1
                document.getElementById('pageFilter').value = '1';
                
                // Load page 1
                filterByPage();
            } else {
                // Show surah/juz/ayah filters and memorize filter, hide page filter
                document.getElementById('juzFilterGroup').style.display = 'block';
                document.getElementById('surahFilterGroup').style.display = 'block';
                document.getElementById('ayahFilterGroup').style.display = 'block';
                document.getElementById('memorizeFilterContainer').style.display = 'flex';
                document.getElementById('pageFilterGroup').style.display = 'none';
                
                // Reset to Al-Fatiha (Surah 1) to avoid loading entire Quran
                document.getElementById('juzFilter').value = '';
                document.getElementById('surahFilter').value = '1';
                document.getElementById('ayahFrom').value = '';
                document.getElementById('ayahTo').value = '';
                
                // Load Al-Fatiha
                filterVerses();
            }
        }

        function filterByPage() {
            const page = parseInt(document.getElementById('pageFilter').value);
            const view = document.getElementById('viewFilter').value;
            
            console.log('Filtering by page:', page);
            
            if (!page) {
                filteredVerses = [...quranData];
            } else {
                // Filter by page number
                filteredVerses = quranData.filter(v => v.page === page);
                console.log('Found verses on page', page, ':', filteredVerses.length);
            }
            
            // Apply memorization filter
            if (view === 'memorized') {
                filteredVerses = filteredVerses.filter(v => 
                    memorizedVerses.has(`${v.surah}:${v.ayah}`)
                );
            } else if (view === 'not_memorized') {
                filteredVerses = filteredVerses.filter(v => 
                    !memorizedVerses.has(`${v.surah}:${v.ayah}`)
                );
            }
            
            // Check current verses per page setting for page view
            const versesPerPageSelect = document.getElementById('versesPerPage');
            const selectedVersesPerPage = versesPerPageSelect ? versesPerPageSelect.value : 'all';
            
            // For page view, default to showing all verses on the page
            if (selectedVersesPerPage === 'all') {
                versesPerPage = filteredVerses.length;
            } else {
                versesPerPage = parseInt(selectedVersesPerPage) || filteredVerses.length;
            }
            
            currentVerseIndex = 0;
            if (filteredVerses.length > 0) {
                displayVerseWithNavigation(0);
            } else {
                document.getElementById('verseDisplay').innerHTML = '<div class="loading">No verses on this page.</div>';
            }
        }

        // Filter and Display Verses
        function changeView(view) {
            // Update hidden select
            document.getElementById('viewFilter').value = view;
            
            // Update button styles
            document.getElementById('viewAllBtn').style.background = view === 'all' ? 'var(--secondary)' : 'var(--text-light)';
            document.getElementById('viewMemorizedBtn').style.background = view === 'memorized' ? 'var(--secondary)' : 'var(--text-light)';
            document.getElementById('viewNotMemorizedBtn').style.background = view === 'not_memorized' ? 'var(--secondary)' : 'var(--text-light)';
            
            // Filter verses
            filterVerses();
        }

        function filterVerses() {
            const view = document.getElementById('viewFilter').value;
            const juz = document.getElementById('juzFilter').value;
            const surah = document.getElementById('surahFilter').value;
            const ayahFrom = document.getElementById('ayahFrom') ? document.getElementById('ayahFrom').value : '';
            const ayahTo = document.getElementById('ayahTo') ? document.getElementById('ayahTo').value : '';

            console.log('Filtering with:', { view, juz, surah, ayahFrom, ayahTo, totalVerses: quranData.length });

            // Update surah options based on juz if juz changed
            const surahFilterElement = document.getElementById('surahFilter');
            const lastJuz = surahFilterElement.dataset.juz || '';
            
            if (juz !== lastJuz) {
                // Juz changed, repopulate surahs
                if (juz) {
                    populateSurahsByJuz(parseInt(juz));
                    surahFilterElement.dataset.juz = juz;
                } else {
                    populateSurahsByJuz(null);
                    surahFilterElement.dataset.juz = '';
                }
                // Keep the current surah selection if it's still valid in the new list
                // Otherwise it will automatically reset to "All Surahs"
            }

            // Update ayah From/To options based on surah
            if (surah) {
                const ayahFromSelect = document.getElementById('ayahFrom');
                const ayahToSelect = document.getElementById('ayahTo');
                
                // Only update if we need to (avoid resetting selections)
                if (ayahFromSelect.options.length <= 1 || ayahFromSelect.dataset.surah !== surah) {
                    ayahFromSelect.innerHTML = '<option value="">From (All)</option>';
                    ayahToSelect.innerHTML = '<option value="">To (All)</option>';
                    
                    const surahVerses = quranData.filter(v => v.surah === parseInt(surah));
                    surahVerses.forEach(v => {
                        const optionFrom = document.createElement('option');
                        optionFrom.value = v.ayah;
                        optionFrom.textContent = `Ayah ${v.ayah}`;
                        ayahFromSelect.appendChild(optionFrom);
                        
                        const optionTo = document.createElement('option');
                        optionTo.value = v.ayah;
                        optionTo.textContent = `Ayah ${v.ayah}`;
                        ayahToSelect.appendChild(optionTo);
                    });
                    
                    ayahFromSelect.dataset.surah = surah;
                    ayahToSelect.dataset.surah = surah;
                }
            } else {
                // Clear ayah options when no surah selected
                document.getElementById('ayahFrom').innerHTML = '<option value="">From (All)</option>';
                document.getElementById('ayahTo').innerHTML = '<option value="">To (All)</option>';
            }

            // Filter verses
            filteredVerses = [...quranData];
            
            // Apply view filter (memorized/not memorized)
            if (view === 'memorized') {
                filteredVerses = filteredVerses.filter(v => 
                    memorizedVerses.has(`${v.surah}:${v.ayah}`)
                );
            } else if (view === 'not_memorized') {
                filteredVerses = filteredVerses.filter(v => 
                    !memorizedVerses.has(`${v.surah}:${v.ayah}`)
                );
            }
            
            // Juz filter
            if (juz) {
                filteredVerses = filteredVerses.filter(v => v.juz === parseInt(juz));
                console.log('After juz filter:', filteredVerses.length);
            }
            
            // Surah filter - MUST APPLY BEFORE AYAH FILTER
            if (surah) {
                filteredVerses = filteredVerses.filter(v => v.surah === parseInt(surah));
                console.log('After surah filter:', filteredVerses.length);
            }
            
            // Ayah range filter - ONLY applies to already filtered surah
            if (ayahFrom && surah) {
                filteredVerses = filteredVerses.filter(v => v.ayah >= parseInt(ayahFrom));
                console.log('After ayahFrom filter:', filteredVerses.length);
            }
            if (ayahTo && surah) {
                filteredVerses = filteredVerses.filter(v => v.ayah <= parseInt(ayahTo));
                console.log('After ayahTo filter:', filteredVerses.length);
            }

            console.log('Final filtered count:', filteredVerses.length);
            
            // Check current verses per page setting
            const versesPerPageSelect = document.getElementById('versesPerPage');
            const selectedVersesPerPage = versesPerPageSelect ? versesPerPageSelect.value : '10';
            
            // Set verses per page based on user's selection
            if (selectedVersesPerPage === 'all') {
                versesPerPage = filteredVerses.length;
            } else {
                versesPerPage = parseInt(selectedVersesPerPage) || 10;
            }
            
            currentVerseIndex = 0;
            if (filteredVerses.length > 0) {
                displayVerseWithNavigation(0);
            } else {
                const container = document.getElementById('verseDisplay');
                container.innerHTML = '<div class="loading">No verses found with selected filters. Try different options.</div>';
            }
        }

        function displayPageView(versesToDisplay, index) {
            const container = document.getElementById('verseDisplay');
            const pageNumber = versesToDisplay[0].page;
            
            // Check if all verses on page are memorized
            const allMemorized = versesToDisplay.every(v => 
                memorizedVerses.has(`${v.surah}:${v.ayah}`)
            );
            const pageRecited = recitedPages.has(pageNumber);
            console.log('Page', pageNumber, 'recited status:', pageRecited, '(total recited pages:', recitedPages.size, ')');
            
            // Create page card
            const pageCard = document.createElement('div');
            pageCard.className = 'verse-card';
            pageCard.style.padding = '2.5rem';
            
            // Page header
            const pageHeader = document.createElement('div');
            const juzNumber = versesToDisplay[0].juz;
            pageHeader.style.cssText = 'text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);';
            pageHeader.innerHTML = `
                <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <span>Page ${pageNumber} | ÿµŸÅÿ≠ÿ© ${pageNumber}</span>
                    ${pageRecited ? '<span style="color: var(--secondary); font-size: 1rem;">‚úì</span>' : ''}
                </div>
                <div style="font-size: 0.95rem; color: var(--accent); margin-top: 0.35rem; font-weight: 600;">
                    Juz ${juzNumber} | ÿßŸÑÿ¨ÿ≤ÿ° ${juzNumber}
                </div>
                <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem;">
                    ${versesToDisplay.length} verses | ${versesToDisplay.length} ÿ¢Ÿäÿ©
                </div>
            `;
            pageCard.appendChild(pageHeader);
            
            // Continuous Arabic text (like actual Quran page)
            const arabicContainer = document.createElement('div');
            arabicContainer.style.cssText = 'font-family: "Amiri", serif; font-size: 2rem; line-height: 2.8; text-align: right; direction: rtl; margin: 2rem 0; padding: 1.5rem; background: var(--bg-light); border-radius: 12px;';
            
            versesToDisplay.forEach((verse, i) => {
                const verseKey = `${verse.surah}:${verse.ayah}`;
                const isBookmarked = bookmarkedVerses.has(verseKey);
                
                // Add verse text with bookmark styling
                const verseSpan = document.createElement('span');
                verseSpan.textContent = verse.arab + ' ';
                verseSpan.style.cssText = `cursor: pointer; transition: all 0.2s ease; color: ${isBookmarked ? 'var(--secondary)' : 'inherit'}; font-weight: ${isBookmarked ? '600' : 'normal'};`;
                verseSpan.title = isBookmarked ? 'Click to remove bookmark' : 'Click to bookmark this ayah';
                verseSpan.onclick = () => toggleBookmark(verseKey);
                
                // Add hover effect to verse text
                verseSpan.onmouseenter = () => {
                    verseSpan.style.color = 'var(--secondary)';
                    verseSpan.style.fontWeight = '600';
                };
                verseSpan.onmouseleave = () => {
                    verseSpan.style.color = isBookmarked ? 'var(--secondary)' : 'inherit';
                    verseSpan.style.fontWeight = isBookmarked ? '600' : 'normal';
                };
                
                arabicContainer.appendChild(verseSpan);
                
                // Add clickable ayah number
                const ayahMarker = document.createElement('span');
                ayahMarker.textContent = '€ù' + verse.ayah + ' ';
                ayahMarker.style.cssText = `cursor: pointer; transition: all 0.2s ease; color: ${isBookmarked ? 'var(--secondary)' : 'inherit'}; font-weight: ${isBookmarked ? '700' : 'normal'};`;
                ayahMarker.title = isBookmarked ? 'Click to remove bookmark' : 'Click to bookmark this ayah';
                ayahMarker.onclick = () => toggleBookmark(verseKey);
                
                // Add hover effect to ayah number
                ayahMarker.onmouseenter = () => {
                    ayahMarker.style.color = 'var(--secondary)';
                    ayahMarker.style.transform = 'scale(1.2)';
                    ayahMarker.style.display = 'inline-block';
                    // Also highlight the verse text
                    verseSpan.style.color = 'var(--secondary)';
                    verseSpan.style.fontWeight = '600';
                };
                ayahMarker.onmouseleave = () => {
                    ayahMarker.style.color = isBookmarked ? 'var(--secondary)' : 'inherit';
                    ayahMarker.style.transform = 'scale(1)';
                    // Reset verse text color
                    verseSpan.style.color = isBookmarked ? 'var(--secondary)' : 'inherit';
                    verseSpan.style.fontWeight = isBookmarked ? '600' : 'normal';
                };
                
                arabicContainer.appendChild(ayahMarker);
            });
            
            pageCard.appendChild(arabicContainer);
            
            // Page controls
            const controlsContainer = document.createElement('div');
            controlsContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--border);';
            
            // Play entire page button
            const playPageBtn = document.createElement('button');
            playPageBtn.className = 'audio-btn';
            playPageBtn.id = 'playPageBtn';
            playPageBtn.style.cssText = 'width: auto; padding: 0.75rem 2rem; border-radius: 10px; font-size: 1rem;';
            playPageBtn.innerHTML = '‚ñ∂ Play Full Page';
            playPageBtn.onclick = () => startPagePlayback(versesToDisplay, playPageBtn);
            
            // Pause/Resume button (hidden initially)
            const pauseBtn = document.createElement('button');
            pauseBtn.id = 'pausePageBtn';
            pauseBtn.style.cssText = 'width: auto; padding: 0.75rem 2rem; border-radius: 10px; font-size: 1rem; display: none;';
            pauseBtn.innerHTML = '‚è∏ Pause';
            pauseBtn.onclick = () => togglePause(pauseBtn);
            
            // Restart button (hidden initially)
            const restartBtn = document.createElement('button');
            restartBtn.id = 'restartPageBtn';
            restartBtn.style.cssText = 'width: auto; padding: 0.75rem 1.5rem; border-radius: 10px; font-size: 0.9rem; background: var(--accent); display: none;';
            restartBtn.innerHTML = '‚Üª Restart';
            restartBtn.onclick = () => restartPagePlayback(versesToDisplay, playPageBtn, pauseBtn, restartBtn);
            
            const playButtonsContainer = document.createElement('div');
            playButtonsContainer.style.cssText = 'display: flex; gap: 0.5rem;';
            playButtonsContainer.appendChild(playPageBtn);
            playButtonsContainer.appendChild(pauseBtn);
            playButtonsContainer.appendChild(restartBtn);
            
            // Mark page as memorized toggle
            const memorizedToggle = document.createElement('div');
            memorizedToggle.style.cssText = 'display: grid; grid-template-columns: auto auto auto auto; gap: 0.75rem; align-items: center; justify-content: start;';
            memorizedToggle.innerHTML = `
                <span style="font-size: 0.95rem; font-weight: 600; white-space: nowrap;">Page Memorized</span>
                <div class="toggle-switch ${allMemorized ? 'active' : ''}" id="pageToggle">
                    <div class="toggle-slider"></div>
                </div>
                <span style="font-size: 0.95rem; font-weight: 600; color: #c8860a; white-space: nowrap;">Page Recited</span>
                <div class="toggle-switch ${pageRecited ? 'active' : ''}" id="pageRecitedToggle" style="${pageRecited ? 'background: linear-gradient(135deg, #c8860a, #e8a020);' : ''}">
                    <div class="toggle-slider"></div>
                </div>
            `;
            
            memorizedToggle.querySelector('#pageToggle').onclick = () => {
                togglePageMemorized(versesToDisplay);
            };

            memorizedToggle.querySelector('#pageRecitedToggle').onclick = () => {
                togglePageRecited(versesToDisplay);
            };
            
            controlsContainer.appendChild(playButtonsContainer);
            controlsContainer.appendChild(memorizedToggle);
            pageCard.appendChild(controlsContainer);
            
            container.appendChild(pageCard);
            
            // Navigation
            addPageNavigation(container, index);
        }
        
        let isPagePlaying = false;
        let isPagePaused = false;
        let currentPageVerses = [];
        let currentPageIndex = 0;
        
        function startPagePlayback(verses, playBtn) {
            // Hide play button, show pause and restart
            playBtn.style.display = 'none';
            document.getElementById('pausePageBtn').style.display = 'block';
            document.getElementById('restartPageBtn').style.display = 'block';
            
            currentPageVerses = verses;
            currentPageIndex = 0;
            isPagePlaying = true;
            isPagePaused = false;
            
            playFullPage(verses);
        }
        
        function togglePause(pauseBtn) {
            if (isPagePaused) {
                // Resume
                isPagePaused = false;
                pauseBtn.innerHTML = '‚è∏ Pause';
                if (audioPlayer) {
                    audioPlayer.play();
                }
            } else {
                // Pause
                isPagePaused = true;
                pauseBtn.innerHTML = '‚ñ∂ Resume';
                if (audioPlayer) {
                    audioPlayer.pause();
                }
            }
        }
        
        function restartPagePlayback(verses, playBtn, pauseBtn, restartBtn) {
            // Stop current playback
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer = null;
            }
            
            // Reset buttons
            playBtn.style.display = 'block';
            pauseBtn.style.display = 'none';
            restartBtn.style.display = 'none';
            pauseBtn.innerHTML = '‚è∏ Pause';
            
            isPagePlaying = false;
            isPagePaused = false;
            currentPageIndex = 0;
        }
        
        function playFullPage(verses) {
            function playNext() {
                if (!isPagePlaying || currentPageIndex >= verses.length) {
                    // Playback complete
                    const playBtn = document.getElementById('playPageBtn');
                    const pauseBtn = document.getElementById('pausePageBtn');
                    const restartBtn = document.getElementById('restartPageBtn');
                    
                    if (playBtn) playBtn.style.display = 'block';
                    if (pauseBtn) {
                        pauseBtn.style.display = 'none';
                        pauseBtn.innerHTML = '‚è∏ Pause';
                    }
                    if (restartBtn) restartBtn.style.display = 'none';
                    
                    isPagePlaying = false;
                    isPagePaused = false;
                    currentPageIndex = 0;
                    console.log('Page playback complete');
                    return;
                }
                
                const verse = verses[currentPageIndex];
                const globalAyahNumber = quranData.findIndex(v => 
                    v.surah === verse.surah && v.ayah === verse.ayah
                ) + 1;
                
                // Build audio URL based on selected reciter
                let audioUrl;
                if (selectedReciter === 'ar.alafasy') {
                    audioUrl = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${globalAyahNumber}.mp3`;
                } else {
                    const paddedSurah = String(verse.surah).padStart(3, '0');
                    const paddedAyah = String(verse.ayah).padStart(3, '0');
                    const formattedNumber = paddedSurah + paddedAyah;
                    audioUrl = `https://everyayah.com/data/${selectedReciter}/${formattedNumber}.mp3`;
                }
                
                if (audioPlayer) {
                    audioPlayer.pause();
                }
                
                audioPlayer = new Audio(audioUrl);
                audioPlayer.play();
                
                audioPlayer.onended = () => {
                    if (!isPagePaused) {
                        currentPageIndex++;
                        playNext();
                    }
                };
                
                audioPlayer.onerror = () => {
                    console.error('Audio error, skipping to next verse');
                    currentPageIndex++;
                    playNext();
                };
            }
            
            playNext();
        }
        
        function togglePageMemorized(verses) {
            const allMemorized = verses.every(v => 
                memorizedVerses.has(`${v.surah}:${v.ayah}`)
            );
            
            verses.forEach(v => {
                const key = `${v.surah}:${v.ayah}`;
                if (allMemorized) {
                    memorizedVerses.delete(key);
                } else {
                    memorizedVerses.add(key);
                }
            });
            
            saveUserData();
            updateAccountStats();
            displayVerseWithNavigation(currentVerseIndex);
        }

        function togglePageRecited(verses) {
            if (!currentUser) {
                alert('Please log in to track your progress');
                return;
            }

            const pageNumber = verses[0].page;
            
            if (recitedPages.has(pageNumber)) {
                recitedPages.delete(pageNumber);
            } else {
                recitedPages.add(pageNumber);
            }

            saveUserData();
            updateAccountStats();
            displayVerseWithNavigation(currentVerseIndex);
        }
        
        function addPageNavigation(container, index) {
            const navHTML = document.createElement('div');
            navHTML.style.cssText = 'display: flex; justify-content: space-between; margin-top: 1.5rem; gap: 1rem;';
            
            const currentPage = filteredVerses[index].page;
            
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Üê Previous Page';
            prevBtn.onclick = () => {
                const prevPageNumber = currentPage - 1;
                if (prevPageNumber >= 1) {
                    document.getElementById('pageFilter').value = prevPageNumber;
                    filterByPage();
                }
            };
            // Disable if on page 1
            if (currentPage <= 1) {
                prevBtn.disabled = true;
                prevBtn.style.opacity = '0.5';
            }
            
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next Page ‚Üí';
            nextBtn.onclick = () => {
                const nextPageNumber = currentPage + 1;
                if (nextPageNumber <= 604) {
                    document.getElementById('pageFilter').value = nextPageNumber;
                    filterByPage();
                }
            };
            // Disable if on page 604
            if (currentPage >= 604) {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
            }
            
            navHTML.appendChild(prevBtn);
            navHTML.appendChild(nextBtn);
            container.appendChild(navHTML);
        }

        function displayVerseWithNavigation(index) {
            if (index < 0 || index >= filteredVerses.length) return;
            
            currentVerseIndex = index;
            
            // Stop any currently playing audio
            stopAudio();
            
            // Get verses for this page
            const endIndex = Math.min(index + versesPerPage, filteredVerses.length);
            const versesToDisplay = filteredVerses.slice(index, endIndex);
            
            // Display all verses on this page
            const container = document.getElementById('verseDisplay');
            container.innerHTML = '';
            
            // Special layout for Page Mode
            if (viewMode === 'page' && versesToDisplay.length > 0) {
                displayPageView(versesToDisplay, index);
                return;
            }
            
            versesToDisplay.forEach((verse, i) => {
                const verseKey = `${verse.surah}:${verse.ayah}`;
                const isMemorized = memorizedVerses.has(verseKey);
                const isBookmarked = bookmarkedVerses.has(verseKey);
                const actualIndex = index + i;
                
                // Calculate the global ayah number for audio (1-6236)
                const globalAyahNumber = quranData.findIndex(v => v.surah === verse.surah && v.ayah === verse.ayah) + 1;
                
                const verseCard = document.createElement('div');
                verseCard.className = 'verse-card';
                
                // Get surah name
                const surahName = getSurahName(verse.surah) || `Surah ${verse.surah}`;
                
                // Determine which translation to show
                let translationHTML = '';
                if (translationMode === 'english') {
                    translationHTML = `<div class="verse-translation">${verse.translation || 'Translation not available'}</div>`;
                } else if (translationMode === 'arabic') {
                    translationHTML = `<div class="verse-translation" style="direction: rtl; text-align: right; font-family: 'Amiri', serif;">${verse.tafseer || 'ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</div>`;
                }
                
                verseCard.innerHTML = `
                    <div class="verse-info">
                        <span style="font-weight: 700; color: var(--primary);">${surahName}</span> - Surah ${verse.surah}, Ayah ${verse.ayah} (Juz ${verse.juz})
                    </div>
                    <div class="verse-arabic">${verse.arab || verse.ar || 'Arabic text not available'}</div>
                    ${translationHTML}
                    
                    <div class="verse-controls">
                        <div class="verse-controls-left">
                            <div class="audio-controls">
                                <button class="audio-btn" data-ayah="${globalAyahNumber}" data-surah="${verse.surah}" data-ayah-num="${verse.ayah}" title="Listen to recitation">‚ñ∂</button>
                            </div>
                            <div class="memorized-toggle">
                                <span style="font-size: 0.9rem; font-weight: 600;">Memorized</span>
                                <div class="toggle-switch ${isMemorized ? 'active' : ''}" data-verse-key="${verseKey}" data-verse-index="${actualIndex}" data-toggle-type="memorized">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <button class="bookmark-btn" data-verse-key="${verseKey}" style="background: ${isBookmarked ? 'var(--secondary)' : 'var(--success)'}; color: white; border: none; font-size: 0.7rem; cursor: pointer; padding: 0.3rem 0.5rem; margin-left: 0.75rem; border-radius: 4px; font-weight: 600; transition: all 0.2s ease;" title="${isBookmarked ? 'Remove bookmark' : 'Bookmark this ayah'}">
                                ${isBookmarked ? '‚úì Saved' : 'Bookmark'}
                            </button>
                        </div>
                    </div>
                `;
                
                // Add click handler to bookmark button
                const bookmarkBtn = verseCard.querySelector('.bookmark-btn');
                bookmarkBtn.addEventListener('click', function() {
                    toggleBookmark(this.dataset.verseKey);
                });
                bookmarkBtn.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.3)';
                });
                bookmarkBtn.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                });
                
                // Add click handler to memorized toggle switch
                const memorizedToggle = verseCard.querySelector('.toggle-switch[data-toggle-type="memorized"]');
                memorizedToggle.addEventListener('click', function() {
                    toggleMemorizedForVerse(this.dataset.verseKey, parseInt(this.dataset.verseIndex));
                });
                
                // Add click handler to audio button
                const audioBtn = verseCard.querySelector('.audio-btn');
                audioBtn.addEventListener('click', function() {
                    playAudio(this.dataset.ayah, this.dataset.surah, this.dataset.ayahNum, this);
                });
                
                container.appendChild(verseCard);
            });
            
            // Check if all verses on this page are memorized
            const allMemorized = versesToDisplay.every(v => memorizedVerses.has(`${v.surah}:${v.ayah}`));
            
            // Add navigation buttons
            const navHTML = document.createElement('div');
            navHTML.style.cssText = 'display: flex; justify-content: space-between; margin-top: 1.5rem; gap: 1rem; align-items: center;';
            
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Üê Previous';
            prevBtn.onclick = () => displayVerseWithNavigation(Math.max(0, index - versesPerPage));
            if (index === 0) {
                prevBtn.disabled = true;
                prevBtn.style.opacity = '0.5';
                prevBtn.style.cursor = 'not-allowed';
            }
            
            const pageInfo = document.createElement('span');
            pageInfo.style.cssText = 'font-size: 0.95rem; font-weight: 600;';
            const startVerse = index + 1;
            const endVerse = Math.min(index + versesPerPage, filteredVerses.length);
            pageInfo.textContent = versesPerPage === 1 
                ? `Verse ${startVerse} of ${filteredVerses.length}`
                : `Verses ${startVerse}-${endVerse} of ${filteredVerses.length}`;
            
            const nextBtn = document.createElement('button');
            
            const isLastPage = index + versesPerPage >= filteredVerses.length;
            
            // Always show "Next" without marking as memorized
            nextBtn.textContent = 'Next ‚Üí';
            if (isLastPage) {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            }
            
            nextBtn.onclick = () => {
                const nextIndex = index + versesPerPage;
                if (nextIndex < filteredVerses.length) {
                    displayVerseWithNavigation(nextIndex);
                }
            };
            
            navHTML.appendChild(prevBtn);
            navHTML.appendChild(pageInfo);
            navHTML.appendChild(nextBtn);
            
            container.appendChild(navHTML);
        }
        
        function playAudio(ayahNumber, surahNum, ayahNum, buttonElement) {
            // If clicking the same button that's playing, stop it
            if (currentlyPlayingButton === buttonElement && audioPlayer && !audioPlayer.paused) {
                stopAudio();
                return;
            }
            
            // Stop any currently playing audio
            stopAudio();
            
            // Build audio URL based on selected reciter
            let audioUrl;
            if (selectedReciter === 'ar.alafasy') {
                // Mishary Al-Afasy from Islamic Network CDN (uses global ayah number)
                audioUrl = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${ayahNumber}.mp3`;
            } else {
                // EveryAyah.com format for other reciters
                // Format: SSSAAA (3-digit surah + 3-digit ayah)
                const paddedSurah = String(surahNum).padStart(3, '0');
                const paddedAyah = String(ayahNum).padStart(3, '0');
                const formattedNumber = paddedSurah + paddedAyah;
                audioUrl = `https://everyayah.com/data/${selectedReciter}/${formattedNumber}.mp3`;
            }
            
            console.log('Playing audio:', audioUrl, 'Reciter:', selectedReciter, 'Surah:', surahNum, 'Ayah:', ayahNum);
            
            // Create new audio player
            audioPlayer = new Audio(audioUrl);
            currentlyPlayingButton = buttonElement;
            
            // Update button appearance
            buttonElement.classList.add('playing');
            buttonElement.textContent = '‚è∏';
            
            // Play the audio
            audioPlayer.play().catch(error => {
                console.error('Error playing audio:', error);
                alert('Failed to play audio. Please check your internet connection.');
                stopAudio();
            });
            
            // When audio ends, auto-play next ayah in the current page
            audioPlayer.addEventListener('ended', () => {
                // Find the current ayah index in filteredVerses
                const currentAyahIndex = filteredVerses.findIndex(v => {
                    const globalAyahNum = quranData.findIndex(qv => qv.surah === v.surah && qv.ayah === v.ayah) + 1;
                    return globalAyahNum === parseInt(ayahNumber);
                });
                
                // Check if there's a next ayah on the current page
                const pageStart = Math.floor(currentVerseIndex / versesPerPage) * versesPerPage;
                const pageEnd = Math.min(pageStart + versesPerPage, filteredVerses.length);
                
                if (currentAyahIndex >= 0 && currentAyahIndex + 1 < pageEnd && currentAyahIndex + 1 < filteredVerses.length) {
                    // Auto-play next ayah
                    const nextVerse = filteredVerses[currentAyahIndex + 1];
                    const nextGlobalAyahNum = quranData.findIndex(v => v.surah === nextVerse.surah && v.ayah === nextVerse.ayah) + 1;
                    const nextButton = document.querySelector(`[data-ayah="${nextGlobalAyahNum}"]`);
                    
                    if (nextButton) {
                        setTimeout(() => {
                            playAudio(nextGlobalAyahNum, nextVerse.surah, nextVerse.ayah, nextButton);
                        }, 500); // Small delay between ayahs
                    } else {
                        stopAudio();
                    }
                } else {
                    stopAudio();
                }
            });
            
            // Handle errors
            audioPlayer.addEventListener('error', (e) => {
                console.error('Audio error:', e);
                alert('Failed to load audio. Please try again.');
                stopAudio();
            });
        }
        
        function stopAudio() {
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer = null;
            }
            
            if (currentlyPlayingButton) {
                currentlyPlayingButton.classList.remove('playing');
                currentlyPlayingButton.textContent = '‚ñ∂';
                currentlyPlayingButton = null;
            }
        }

        function updateVersesPerPage() {
            const selected = document.getElementById('versesPerPage').value;
            if (selected === 'all') {
                versesPerPage = filteredVerses.length;
            } else {
                versesPerPage = parseInt(selected);
            }
            // Reset to beginning of current verse's page
            const newIndex = Math.floor(currentVerseIndex / versesPerPage) * versesPerPage;
            displayVerseWithNavigation(newIndex);
        }

        function toggleMemorizedForVerse(verseKey, verseIndex) {
            if (!currentUser) {
                alert('Please log in to track your progress');
                return;
            }

            if (memorizedVerses.has(verseKey)) {
                memorizedVerses.delete(verseKey);
            } else {
                memorizedVerses.add(verseKey);
            }

            saveUserData();
            updateAccountStats();
            
            // Refresh the current page display
            displayVerseWithNavigation(currentVerseIndex);
        }

        function toggleBookmark(verseKey) {
            if (!currentUser) {
                alert('Please log in to save bookmarks');
                return;
            }

            if (bookmarkedVerses.has(verseKey)) {
                bookmarkedVerses.delete(verseKey);
            } else {
                bookmarkedVerses.add(verseKey);
            }

            saveUserData();
            updateAccountStats();
            
            // Refresh the current page display
            displayVerseWithNavigation(currentVerseIndex);
        }


        // Display Single Verse
        function displayVerse(verse) {
            const container = document.getElementById('verseDisplay');
            
            if (!verse) {
                container.innerHTML = '<div class="loading">Please select a filter above to view verses, or the data is still loading...</div>';
                return;
            }

            console.log('Displaying verse:', verse);
            currentVerse = verse;
            const verseKey = `${verse.surah}:${verse.ayah}`;
            const isMemorized = memorizedVerses.has(verseKey);

            container.innerHTML = `
                <div class="verse-card">
                    <div class="verse-info">Surah ${verse.surah}, Ayah ${verse.ayah} (Juz ${verse.juz})</div>
                    <div class="verse-arabic">${verse.arab || verse.ar || 'Arabic text not available'}</div>
                    <div class="verse-translation">${verse.translation || verse.en || verse.tr || 'Translation not available'}</div>
                    
                    <div class="memorized-toggle">
                        <span style="font-size: 1.2rem; font-weight: 600;">Memorized</span>
                        <div class="toggle-switch ${isMemorized ? 'active' : ''}" onclick="toggleMemorized()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Account Management
        async function login() {
            try {
                console.log('=== LOGIN FUNCTION CALLED ===');
                
                // Get the email input element
                const emailInput = document.getElementById('email');
                console.log('Email input element found:', !!emailInput);
                
                if (!emailInput) {
                    console.error('CRITICAL: Email input not found in DOM');
                    alert('Error: Cannot find email input. Please refresh the page.');
                    return false;
                }
                
                // Get the email value
                const email = emailInput.value ? emailInput.value.trim() : '';
                console.log('Email value:', email);
                console.log('Email length:', email.length);
                
                // Validation
                if (!email || email.length === 0) {
                    console.warn('Empty email');
                    alert('Please enter an email address');
                    if (emailInput) emailInput.focus();
                    return false;
                }
                
                if (email.indexOf('@') === -1 || email.indexOf('.') === -1) {
                    console.warn('Invalid email format');
                    alert('Please enter a valid email (e.g., user@example.com)');
                    if (emailInput) emailInput.focus();
                    return false;
                }
                
                console.log('Email validation passed');
                
                // Set current user
                currentUser = email;
                console.log('Current user set to:', currentUser);
                
                // Load user data and WAIT for it to complete
                console.log('Loading user data...');
                await loadUserData();
                console.log('User data loaded');
                
                // Get DOM elements
                const loginForm = document.getElementById('loginForm');
                const accountDashboard = document.getElementById('accountDashboard');
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                console.log('DOM elements:', {
                    loginForm: !!loginForm,
                    accountDashboard: !!accountDashboard,
                    welcomeMessage: !!welcomeMessage
                });
                
                // Update UI
                if (loginForm) {
                    loginForm.style.display = 'none';
                    console.log('Login form hidden');
                }
                
                if (accountDashboard) {
                    accountDashboard.style.display = 'block';
                    console.log('Account dashboard shown');
                }
                
                if (welcomeMessage) {
                    welcomeMessage.textContent = 'Welcome, ' + email + '!';
                    console.log('Welcome message set');
                }
                
                // Update stats
                console.log('Updating account stats...');
                updateAccountStats();
                console.log('Account stats updated');
                
                // Save to localStorage
                try {
                    localStorage.setItem('quran_user', email);
                    console.log('User saved to localStorage successfully');
                } catch (storageError) {
                    console.error('localStorage error:', storageError);
                    console.log('Continuing without localStorage...');
                }
                
                console.log('=== LOGIN SUCCESSFUL ===');
                return true;
                
            } catch (error) {
                console.error('=== LOGIN ERROR ===');
                console.error('Error details:', error);
                console.error('Error stack:', error.stack);
                alert('Login failed: ' + error.message + '. Please try again or refresh the page.');
                return false;
            }
        }

        function logout() {
            currentUser = null;
            memorizedVerses.clear();
            reviewedVerses.clear();
            recitedPages.clear();
            bookmarkedVerses.clear();
            
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('accountDashboard').style.display = 'none';
            document.getElementById('email').value = '';
            
            localStorage.removeItem('quran_user');
        }

        function resetRecitedProgress() {
            if (!confirm('Reset all recitation progress? This cannot be undone.')) return;
            recitedPages.clear();
            saveUserData();
            updateAccountStats();
            
            // Refresh display if on memorize page
            if (document.getElementById('memorize').classList.contains('active') && filteredVerses.length > 0) {
                displayVerseWithNavigation(currentVerseIndex);
            }
            
            // Show confirmation
            alert('Recitation progress has been reset!');
        }

        async function checkSavedUser() {
            const savedUser = localStorage.getItem('quran_user');
            if (savedUser) {
                document.getElementById('email').value = savedUser;
                await login();
            }
        }

        async function saveUserData() {
            if (!currentUser) return;
            
            const data = {
                email: currentUser,
                memorized: Array.from(memorizedVerses),
                reviewed: Array.from(reviewedVerses),
                recited: Array.from(recitedPages),
                bookmarked: Array.from(bookmarkedVerses),
                language: language,
                reciter: selectedReciter,
                lastViewMode: viewMode,
                lastVerseIndex: currentVerseIndex
            };
            
            // Save to localStorage as backup
            localStorage.setItem(`quran_data_${currentUser}`, JSON.stringify(data));
            console.log('üíæ Saving data:');
            console.log('  - Memorized:', memorizedVerses.size, 'verses');
            console.log('  - Reviewed:', reviewedVerses.size, 'verses');
            console.log('  - Recited:', recitedPages.size, 'pages');
            console.log('  - Bookmarked:', bookmarkedVerses.size, 'verses');
            console.log('  - View Mode:', viewMode);
            console.log('  - Verse Index:', currentVerseIndex);
            console.log('Full data object:', data);
            
            // Save to database
            try {
                const response = await fetch('https://quran-memorization-app-1.onrender.com/save-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                console.log('‚úÖ Backend save response:', result);
                if (result.success) {
                    console.log('‚úÖ Data successfully saved to backend');
                } else {
                    console.warn('‚ö†Ô∏è Backend save may have failed:', result);
                }
            } catch (error) {
                console.error('‚ùå Failed to save to database:', error);
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load from database
                const response = await fetch(`https://quran-memorization-app-1.onrender.com/load-progress/${encodeURIComponent(currentUser)}`);
                const result = await response.json();
                
                if (result.success) {
                    memorizedVerses = new Set(result.memorized || []);
                    reviewedVerses = new Set(result.reviewed || []);
                    recitedPages = new Set(result.recited || []);
                    bookmarkedVerses = new Set(result.bookmarked || []);
                    
                    // Warn if backend doesn't have new fields
                    if (!result.hasOwnProperty('recited')) {
                        console.warn('‚ö†Ô∏è Backend database does not have "recited" field. Update backend schema to persist recited pages.');
                    }
                    if (!result.hasOwnProperty('bookmarked')) {
                        console.warn('‚ö†Ô∏è Backend database does not have "bookmarked" field. Update backend schema to persist bookmarks.');
                    }
                    if (!result.hasOwnProperty('lastViewMode')) {
                        console.warn('‚ö†Ô∏è Backend database does not have "lastViewMode" field. Update backend schema to persist view mode.');
                    }
                    
                    // Load language preference
                    if (result.language) {
                        language = result.language;
                        const langSelector = document.getElementById('languageSelector');
                        if (langSelector) {
                            // Set value without triggering onchange
                            const currentOnChange = langSelector.onchange;
                            langSelector.onchange = null;
                            langSelector.value = language;
                            langSelector.onchange = currentOnChange;
                        }
                        document.body.dir = language === 'ar' ? 'rtl' : 'ltr';
                        try {
                            updateUILanguage();
                        } catch (e) {
                            console.warn('Could not update UI language:', e);
                        }
                    }
                    
                    // Load reciter preference
                    if (result.reciter) {
                        selectedReciter = result.reciter;
                        document.getElementById('reciterSelector').value = selectedReciter;
                    }
                    
                    // Restore last view mode and position
                    if (result.lastViewMode) {
                        viewMode = result.lastViewMode;
                        switchViewMode(); // Apply the view mode
                    }
                    if (result.lastVerseIndex !== undefined) {
                        currentVerseIndex = result.lastVerseIndex;
                    }
                    
                    console.log('‚úÖ Loaded from database:');
                    console.log('  - Memorized:', memorizedVerses.size, 'verses');
                    console.log('  - Reviewed:', reviewedVerses.size, 'verses');
                    console.log('  - Recited:', recitedPages.size, 'pages');
                    console.log('  - Bookmarked:', bookmarkedVerses.size, 'verses');
                    console.log('  - View Mode:', viewMode);
                    console.log('  - Verse Index:', currentVerseIndex);
                    console.log('Full result object:', result);
                    
                    // Update stats after loading
                    updateAccountStats();
                    
                    // Refresh display to last position
                    if (filteredVerses.length > 0) {
                        displayVerseWithNavigation(currentVerseIndex);
                    }
                    return;
                }
            } catch (error) {
                console.error('Failed to load from database, using localStorage:', error);
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem(`quran_data_${currentUser}`);
            if (saved) {
                const data = JSON.parse(saved);
                memorizedVerses = new Set(data.memorized || []);
                reviewedVerses = new Set(data.reviewed || []);
                recitedPages = new Set(data.recited || []);
                bookmarkedVerses = new Set(data.bookmarked || []);
                
                // Load language preference
                if (data.language) {
                    language = data.language;
                    document.getElementById('languageSelector').value = language;
                    try {
                        updateUILanguage();
                    } catch (e) {
                        console.warn('Could not update UI language:', e);
                    }
                }
                
                // Load reciter preference
                if (data.reciter) {
                    selectedReciter = data.reciter;
                    document.getElementById('reciterSelector').value = selectedReciter;
                }
                
                // Restore last view mode and position
                if (data.lastViewMode) {
                    viewMode = data.lastViewMode;
                    switchViewMode(); // Apply the view mode
                }
                if (data.lastVerseIndex !== undefined) {
                    currentVerseIndex = data.lastVerseIndex;
                }
                
                console.log('üíø Loaded from localStorage:');
                console.log('  - Memorized:', memorizedVerses.size, 'verses');
                console.log('  - Reviewed:', reviewedVerses.size, 'verses');
                console.log('  - Recited:', recitedPages.size, 'pages');
                console.log('  - Bookmarked:', bookmarkedVerses.size, 'verses');
                console.log('  - View Mode:', viewMode);
                console.log('  - Verse Index:', currentVerseIndex);
                console.log('Full data object:', data);
                
                // Update stats after loading
                updateAccountStats();
                
                // Refresh display to last position
                if (filteredVerses.length > 0) {
                    displayVerseWithNavigation(currentVerseIndex);
                }
            }
        }

        function updateAccountStats() {
            const total = memorizedVerses.size;
            const totalQuran = 6236;
            const percentage = ((total / totalQuran) * 100).toFixed(1);

            // Count completed surahs
            let completedSurahs = 0;
            for (let i = 1; i <= 114; i++) {
                const surahVerses = quranData.filter(v => v.surah === i);
                const memorizedInSurah = surahVerses.filter(v => 
                    memorizedVerses.has(`${v.surah}:${v.ayah}`)
                ).length;
                
                if (memorizedInSurah === surahVerses.length && surahVerses.length > 0) {
                    completedSurahs++;
                }
            }

            // Review progress
            const reviewedCount = reviewedVerses.size;
            const reviewPercentage = total > 0 ? ((reviewedCount / total) * 100).toFixed(1) : 0;

            // Recited progress (pages)
            const totalPages = 604;
            const recitedCount = recitedPages.size;
            const recitedPercentage = ((recitedCount / totalPages) * 100).toFixed(1);

            document.getElementById('totalVerses').textContent = total;
            document.getElementById('completionPercent').textContent = percentage + '%';
            document.getElementById('surahCount').textContent = completedSurahs;
            document.getElementById('reviewedCount').textContent = reviewedCount;
            document.getElementById('recitedCount').textContent = recitedCount;
            document.getElementById('progressText').textContent = `${total} / ${totalQuran} verses`;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('reviewProgressText').textContent = `${reviewedCount} / ${total} memorized verses`;
            document.getElementById('reviewProgressFill').style.width = reviewPercentage + '%';
            document.getElementById('recitedProgressText').textContent = `${recitedCount} / ${totalPages} pages`;
            document.getElementById('recitedProgressFill').style.width = recitedPercentage + '%';
            
            // Update bookmarks
            updateBookmarksDisplay();
            
            // Update quiz surah filter
            updateQuizSurahFilter();
        }

        function updateBookmarksDisplay() {
            const bookmarkCount = document.getElementById('bookmarkCount');
            const bookmarksEmpty = document.getElementById('bookmarksEmpty');
            const bookmarksList = document.getElementById('bookmarksList');
            const bookmarksPreview = document.getElementById('bookmarksPreview');
            
            if (!bookmarkCount) return;
            
            bookmarkCount.textContent = bookmarkedVerses.size;
            
            if (bookmarkedVerses.size === 0) {
                bookmarksEmpty.style.display = 'block';
                bookmarksList.style.display = 'none';
            } else {
                bookmarksEmpty.style.display = 'none';
                bookmarksList.style.display = 'block';
                
                // Show preview of first 5 bookmarks in sequential order
                bookmarksPreview.innerHTML = '';
                
                // Sort bookmarks by surah:ayah order
                const bookmarksArray = Array.from(bookmarkedVerses).sort((a, b) => {
                    const [surahA, ayahA] = a.split(':').map(Number);
                    const [surahB, ayahB] = b.split(':').map(Number);
                    if (surahA !== surahB) return surahA - surahB;
                    return ayahA - ayahB;
                }).slice(0, 5);
                
                bookmarksArray.forEach(verseKey => {
                    const [surah, ayah] = verseKey.split(':');
                    const verseData = quranData.find(v => v.surah === parseInt(surah) && v.ayah === parseInt(ayah));
                    
                    if (verseData) {
                        const surahName = getSurahName(parseInt(surah)) || `Surah ${surah}`;
                        const item = document.createElement('div');
                        item.style.cssText = 'padding: 0.75rem; margin-bottom: 0.5rem; background: white; border-radius: 6px; border-left: 3px solid var(--secondary);';
                        item.innerHTML = `
                            <div style="font-size: 0.95rem; color: var(--primary); font-weight: 700; margin-bottom: 0.35rem;">
                                ${surahName}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--accent); font-weight: 600; margin-bottom: 0.35rem;">
                                Surah ${surah}, Ayah ${ayah}
                            </div>
                            <div style="font-size: 0.9rem; direction: rtl; text-align: right; font-family: 'Amiri', serif;">
                                ${verseData.arab.substring(0, 100)}${verseData.arab.length > 100 ? '...' : ''}
                            </div>
                        `;
                        bookmarksPreview.appendChild(item);
                    }
                });
                
                if (bookmarkedVerses.size > 5) {
                    const more = document.createElement('div');
                    more.style.cssText = 'text-align: center; padding: 0.5rem; color: var(--text-light); font-size: 0.85rem;';
                    more.textContent = `+${bookmarkedVerses.size - 5} more bookmarks`;
                    bookmarksPreview.appendChild(more);
                }
            }
        }

        function viewAllBookmarks() {
            showPage('bookmarks');
        }
        
        let bookmarkTranslationMode = 'hide'; // Separate translation setting for bookmarks page
        
        function changeBookmarkTranslation() {
            const value = document.getElementById('bookmarkTranslationMode').value;
            bookmarkTranslationMode = value;
            displayBookmarksPage();
        }
        
        function displayBookmarksPage() {
            const emptyState = document.getElementById('bookmarksEmpty');
            const display = document.getElementById('bookmarksDisplay');
            
            if (bookmarkedVerses.size === 0) {
                emptyState.style.display = 'block';
                display.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            display.innerHTML = '';
            
            // Sort bookmarks by surah:ayah order
            const bookmarksArray = Array.from(bookmarkedVerses).sort((a, b) => {
                const [surahA, ayahA] = a.split(':').map(Number);
                const [surahB, ayahB] = b.split(':').map(Number);
                if (surahA !== surahB) return surahA - surahB;
                return ayahA - ayahB;
            });
            
            bookmarksArray.forEach(verseKey => {
                const [surah, ayah] = verseKey.split(':');
                const verseData = quranData.find(v => v.surah === parseInt(surah) && v.ayah === parseInt(ayah));
                
                if (verseData) {
                    const surahName = getSurahName(parseInt(surah)) || `Surah ${surah}`;
                    const isMemorized = memorizedVerses.has(verseKey);
                    
                    // Determine translation HTML
                    let translationHTML = '';
                    if (bookmarkTranslationMode === 'english') {
                        translationHTML = `<div class="verse-translation">${verseData.translation || 'Translation not available'}</div>`;
                    } else if (bookmarkTranslationMode === 'arabic') {
                        translationHTML = `<div class="verse-translation" style="direction: rtl; text-align: right; font-family: 'Amiri', serif;">${verseData.tafseer || 'ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ± ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</div>`;
                    }
                    
                    const verseCard = document.createElement('div');
                    verseCard.className = 'verse-card';
                    verseCard.innerHTML = `
                        <div class="verse-info">
                            <span style="font-weight: 700; color: var(--primary);">${surahName}</span> - Surah ${surah}, Ayah ${ayah} (Juz ${verseData.juz})
                        </div>
                        <div class="verse-arabic">${verseData.arab}</div>
                        ${translationHTML}
                        
                        <div class="verse-controls">
                            <div class="verse-controls-left">
                                <div class="audio-controls">
                                    <button class="audio-btn" data-ayah="${quranData.findIndex(v => v.surah === verseData.surah && v.ayah === verseData.ayah) + 1}" title="Listen to recitation">‚ñ∂</button>
                                </div>
                                <div class="memorized-toggle">
                                    <span style="font-size: 0.9rem; font-weight: 600;">Memorized</span>
                                    <div class="toggle-switch ${isMemorized ? 'active' : ''}" data-verse-key="${verseKey}">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <button class="bookmark-remove-btn" data-verse-key="${verseKey}" style="background: var(--error); color: white; border: none; font-size: 0.7rem; cursor: pointer; padding: 0.3rem 0.5rem; margin-left: 0.75rem; border-radius: 4px; font-weight: 600; transition: all 0.2s ease;">
                                    ${translations[language].remove}
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add remove bookmark handler
                    const removeBtn = verseCard.querySelector('.bookmark-remove-btn');
                    removeBtn.addEventListener('click', function() {
                        toggleBookmark(this.dataset.verseKey);
                    });
                    
                    // Add memorized toggle handler
                    const toggle = verseCard.querySelector('.toggle-switch');
                    toggle.addEventListener('click', function() {
                        toggleMemorizedForVerse(this.dataset.verseKey, 0);
                    });
                    
                    // Add audio button handler
                    const audioBtn = verseCard.querySelector('.audio-btn');
                    audioBtn.addEventListener('click', function() {
                        playAudio(this.dataset.ayah);
                    });
                    
                    display.appendChild(verseCard);
                }
            });
        }
        
        function updateQuizSurahFilter() {
            const select = document.getElementById('quizSurahFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="">All Memorized Verses</option>';
            
            // Get all surahs that have at least one memorized verse
            const memorizedSurahs = new Set();
            memorizedVerses.forEach(verseKey => {
                const surah = parseInt(verseKey.split(':')[0]);
                memorizedSurahs.add(surah);
            });
            
            // Add options for each memorized surah
            const surahNames = {
                1: "Al-Fatihah", 2: "Al-Baqarah", 3: "Ali 'Imran", 4: "An-Nisa", 
                5: "Al-Ma'idah", 6: "Al-An'am", 7: "Al-A'raf", 8: "Al-Anfal",
                9: "At-Tawbah", 10: "Yunus", 11: "Hud", 12: "Yusuf",
                13: "Ar-Ra'd", 14: "Ibrahim", 15: "Al-Hijr", 16: "An-Nahl",
                17: "Al-Isra", 18: "Al-Kahf", 19: "Maryam", 20: "Ta-Ha",
                21: "Al-Anbya", 22: "Al-Hajj", 23: "Al-Mu'minun", 24: "An-Nur",
                25: "Al-Furqan", 26: "Ash-Shu'ara", 27: "An-Naml", 28: "Al-Qasas",
                29: "Al-'Ankabut", 30: "Ar-Rum", 31: "Luqman", 32: "As-Sajdah",
                33: "Al-Ahzab", 34: "Saba", 35: "Fatir", 36: "Ya-Sin",
                37: "As-Saffat", 38: "Sad", 39: "Az-Zumar", 40: "Ghafir",
                41: "Fussilat", 42: "Ash-Shuraa", 43: "Az-Zukhruf", 44: "Ad-Dukhan",
                45: "Al-Jathiyah", 46: "Al-Ahqaf", 47: "Muhammad", 48: "Al-Fath",
                49: "Al-Hujurat", 50: "Qaf", 51: "Adh-Dhariyat", 52: "At-Tur",
                53: "An-Najm", 54: "Al-Qamar", 55: "Ar-Rahman", 56: "Al-Waqi'ah",
                57: "Al-Hadid", 58: "Al-Mujadila", 59: "Al-Hashr", 60: "Al-Mumtahanah",
                61: "As-Saf", 62: "Al-Jumu'ah", 63: "Al-Munafiqun", 64: "At-Taghabun",
                65: "At-Talaq", 66: "At-Tahrim", 67: "Al-Mulk", 68: "Al-Qalam",
                69: "Al-Haqqah", 70: "Al-Ma'arij", 71: "Nuh", 72: "Al-Jinn",
                73: "Al-Muzzammil", 74: "Al-Muddaththir", 75: "Al-Qiyamah", 76: "Al-Insan",
                77: "Al-Mursalat", 78: "An-Naba", 79: "An-Nazi'at", 80: "'Abasa",
                81: "At-Takwir", 82: "Al-Infitar", 83: "Al-Mutaffifin", 84: "Al-Inshiqaq",
                85: "Al-Buruj", 86: "At-Tariq", 87: "Al-A'la", 88: "Al-Ghashiyah",
                89: "Al-Fajr", 90: "Al-Balad", 91: "Ash-Shams", 92: "Al-Layl",
                93: "Ad-Duhaa", 94: "Ash-Sharh", 95: "At-Tin", 96: "Al-'Alaq",
                97: "Al-Qadr", 98: "Al-Bayyinah", 99: "Az-Zalzalah", 100: "Al-'Adiyat",
                101: "Al-Qari'ah", 102: "At-Takathur", 103: "Al-'Asr", 104: "Al-Humazah",
                105: "Al-Fil", 106: "Quraysh", 107: "Al-Ma'un", 108: "Al-Kawthar",
                109: "Al-Kafirun", 110: "An-Nasr", 111: "Al-Masad", 112: "Al-Ikhlas",
                113: "Al-Falaq", 114: "An-Nas"
            };
            
            Array.from(memorizedSurahs).sort((a, b) => a - b).forEach(surah => {
                const option = document.createElement('option');
                option.value = surah;
                const memorizedCount = Array.from(memorizedVerses).filter(v => 
                    parseInt(v.split(':')[0]) === surah
                ).length;
                option.textContent = `${surah}. ${getSurahName(surah)} (${memorizedCount} verses)`;
                select.appendChild(option);
            });
        }

        // Quiz Functions
        function updateQuizAyahRange() {
            const surahId = parseInt(document.getElementById('quizSurahFilter').value);
            const ayahFrom = document.getElementById('quizAyahFrom');
            const ayahTo = document.getElementById('quizAyahTo');
            
            // Clear previous options
            ayahFrom.innerHTML = '<option value="">From (All)</option>';
            ayahTo.innerHTML = '<option value="">To (All)</option>';
            
            if (!surahId) return;
            
            // Get ayahs in this surah
            const surahVerses = quranData.filter(v => v.surah === surahId);
            const maxAyah = Math.max(...surahVerses.map(v => v.ayah));
            
            // Populate From dropdown
            for (let i = 1; i <= maxAyah; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Ayah ${i}`;
                ayahFrom.appendChild(option);
            }
            
            // Populate To dropdown
            for (let i = 1; i <= maxAyah; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Ayah ${i}`;
                ayahTo.appendChild(option);
            }
        }

        function startQuiz() {
            if (!currentUser) {
                alert('Please log in to take the quiz');
                showPage('account');
                return;
            }

            if (memorizedVerses.size < 1) {
                alert('Please memorize at least 1 verse before taking the quiz');
                showPage('memorize');
                return;
            }

            const selectedSurah = document.getElementById('quizSurahFilter').value;
            const ayahFrom = document.getElementById('quizAyahFrom').value;
            const ayahTo = document.getElementById('quizAyahTo').value;
            
            // Get memorized verses, filtered by surah if selected
            let quizPool = Array.from(memorizedVerses);
            if (selectedSurah) {
                quizPool = quizPool.filter(verseKey => {
                    const [surah, ayah] = verseKey.split(':').map(Number);
                    if (surah !== parseInt(selectedSurah)) return false;
                    
                    // Apply ayah range filter
                    if (ayahFrom && ayah < parseInt(ayahFrom)) return false;
                    if (ayahTo && ayah > parseInt(ayahTo)) return false;
                    
                    return true;
                });
            }
            
            if (quizPool.length < 1) {
                alert('Not enough memorized verses in this surah. Please select a different surah or memorize more verses.');
                return;
            }
            
            // Sort verses in chronological order (by surah then ayah)
            quizPool.sort((a, b) => {
                const [surahA, ayahA] = a.split(':').map(Number);
                const [surahB, ayahB] = b.split(':').map(Number);
                if (surahA !== surahB) return surahA - surahB;
                return ayahA - ayahB;
            });
            
            console.log('Quiz pool (chronological order):', quizPool);
            
            // Use ALL verses from the pool (no limit to 10)
            currentQuizVerses = quizPool;
            currentQuizIndex = 0;
            quizScore = 0;
            quizTotal = 0;
            
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizResults').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            
            generateQuizQuestion();
        }

        function generateQuizQuestion() {
            console.log(`=== Generating question ${currentQuizIndex + 1} of ${currentQuizVerses.length} ===`);
            
            if (currentQuizIndex >= currentQuizVerses.length) {
                console.log('Quiz complete - showing results');
                showQuizResults();
                return;
            }
            
            const verseKey = currentQuizVerses[currentQuizIndex];
            console.log('Current verse key:', verseKey);
            
            const [surah, ayah] = verseKey.split(':').map(Number);
            const verse = quranData.find(v => v.surah === surah && v.ayah === ayah);

            if (!verse || !verse.arab) {
                console.error('ERROR: Verse not found or has no Arabic text:', verseKey);
                alert(`Error: Verse ${verseKey} not found. Skipping to next question.`);
                // Mark as reviewed even if error
                reviewedVerses.add(verseKey);
                quizTotal++; // Count as attempted
                currentQuizIndex++;
                generateQuizQuestion();
                return;
            }

            console.log('Verse found:', verse.arab);

            // Split verse into words - accept ANY length words
            const allWords = verse.arab.split(/\s+/).filter(w => w.trim().length > 0);
            console.log('Total words in verse:', allWords.length);
            console.log('Words:', allWords);
            
            // For very short verses (1-2 words), we'll still create a question
            // by asking to complete the entire verse
            if (allWords.length === 0) {
                console.error('ERROR: Verse has no words');
                alert(`Error: Verse ${verseKey} has no content. Skipping.`);
                reviewedVerses.add(verseKey);
                quizTotal++;
                currentQuizIndex++;
                generateQuizQuestion();
                return;
            }
            
            // Get difficulty setting
            const difficulty = 1; // Temporarily fixed to easy mode (1 word)
            console.log('Quiz difficulty:', difficulty, 'missing words');
            
            let blankIndices = [];
            let correctAnswers = [];
            let questionWords;
            
            // Determine how many words to blank based on difficulty and verse length
            const numBlanks = 1; // Always 1 for now
            
            if (allWords.length === 1) {
                // Single word verse - blank the whole thing
                blankIndices = [0];
                correctAnswers = [allWords[0]];
                questionWords = ['<span class="quiz-blank">____</span>'];
            } else {
                // Multiple words - pick one longer word to blank
                const wordInfo = allWords.map((w, i) => ({word: w, index: i, length: w.length}));
                
                // Sort by length and pick from top candidates
                wordInfo.sort((a, b) => b.length - a.length);
                
                // Select one word to blank from top half
                const candidatePool = wordInfo.slice(0, Math.ceil(wordInfo.length / 2));
                const chosen = candidatePool[Math.floor(Math.random() * candidatePool.length)];
                
                blankIndices = [chosen.index];
                correctAnswers = [chosen.word];
                
                questionWords = [...allWords];
                questionWords[chosen.index] = '<span class="quiz-blank">____</span>';
            }
            
            console.log('Blanking words at indices:', blankIndices, 'Words:', correctAnswers);
            
            // Single blank - simple answer
            const correctAnswer = correctAnswers[0];
            console.log('Correct answer (combined):', correctAnswer);

            // Create wrong answers
            const wrongAnswers = [];
            
            // Strategy 1: Same surah
            const sameSurahVerses = quranData.filter(v => v.surah === surah && v.arab);
            
            // Strategy 2: Nearby surahs
            const nearbyVerses = quranData.filter(v => 
                Math.abs(v.surah - surah) <= 5 && v.arab
            );
            
            // Strategy 3: All verses
            const allVerses = quranData.filter(v => v.arab);
            
            let attempts = 0;
            const maxAttempts = 500;
            
            while (wrongAnswers.length < 3 && attempts < maxAttempts) {
                attempts++;
                
                // Choose source based on attempts
                let sourceVerses = sameSurahVerses;
                if (attempts > 100) sourceVerses = nearbyVerses;
                if (attempts > 200) sourceVerses = allVerses;
                
                if (sourceVerses.length === 0) {
                    console.warn('No source verses available at attempt', attempts);
                    continue;
                }
                
                const randomVerse = sourceVerses[Math.floor(Math.random() * sourceVerses.length)];
                if (!randomVerse || !randomVerse.arab) continue;
                
                const candidateWords = randomVerse.arab.split(/\s+/).filter(w => w.trim().length > 0);
                if (candidateWords.length === 0) continue;
                
                // Pick a single random word
                const wrongAnswer = candidateWords[Math.floor(Math.random() * candidateWords.length)];
                
                // Must be different from correct answer and not already added
                if (wrongAnswer !== correctAnswer && 
                    !wrongAnswers.includes(wrongAnswer) &&
                    wrongAnswer.trim() !== correctAnswer.trim()) {
                    wrongAnswers.push(wrongAnswer);
                    console.log(`Found wrong answer ${wrongAnswers.length}:`, wrongAnswer);
                }
            }
            
            console.log('Total wrong answers collected:', wrongAnswers.length);
            
            // Fallback: if still not enough wrong answers, create placeholders
            while (wrongAnswers.length < 3) {
                const placeholder = `[Option ${wrongAnswers.length + 1}]`;
                wrongAnswers.push(placeholder);
                console.warn('Using placeholder wrong answer:', placeholder);
            }

            // Shuffle all answers
            const allAnswers = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);
            console.log('All answers (shuffled):', allAnswers);

            // Build the question display
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 0.95rem; color: var(--text-light);">
                        Question ${currentQuizIndex + 1} of ${currentQuizVerses.length}
                    </div>
                    <button onclick="finishQuizEarly()" style="background: var(--error); padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Finish Quiz
                    </button>
                </div>
                <div class="verse-info">Surah ${verse.surah}, Ayah ${verse.ayah}</div>
                <div class="quiz-question">${questionWords.join(' ')}</div>
                <div class="quiz-options" id="quizOptionsContainer">
                    ${allAnswers.map((answer, idx) => `
                        <div class="quiz-option" data-answer="${answer.replace(/"/g, '&quot;')}" data-correct="${correctAnswer.replace(/"/g, '&quot;')}" data-index="${idx}">
                            ${answer}
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Add click handlers to options
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    const selected = this.dataset.answer;
                    const correct = this.dataset.correct;
                    checkAnswer(this, selected, correct);
                });
            });
            
            console.log('=== Question displayed successfully ===');
        }
        
        function finishQuizEarly() {
            if (confirm('Are you sure you want to finish the quiz early? Your progress will be saved.')) {
                // Mark remaining verses as reviewed
                for (let i = currentQuizIndex; i < currentQuizVerses.length; i++) {
                    reviewedVerses.add(currentQuizVerses[i]);
                }
                showQuizResults();
            }
        }

        function checkAnswer(element, selected, correct) {
            quizTotal++;
            
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                if (opt.textContent.trim() === correct) {
                    opt.classList.add('correct');
                }
            });

            if (selected === correct) {
                quizScore++;
                element.classList.add('correct');
            } else {
                element.classList.add('incorrect');
            }
            
            // Mark this verse as reviewed
            const verseKey = currentQuizVerses[currentQuizIndex];
            reviewedVerses.add(verseKey);

            // Next question after delay
            setTimeout(() => {
                currentQuizIndex++;
                generateQuizQuestion();
            }, 1500);
        }

        function showQuizResults() {
            // Save reviewed verses
            saveUserData();
            updateAccountStats();
            
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('quizResults').style.display = 'block';
            document.getElementById('quizScore').textContent = `${quizScore} / ${quizTotal}`;
            document.getElementById('quizVerseCount').textContent = `${currentQuizVerses.length}`;
        }
        
        function resetQuiz() {
            document.getElementById('quizSetup').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('quizResults').style.display = 'none';
            currentQuizVerses = [];
            currentQuizIndex = 0;
        }

        // Navigation
        // Prayer Times
        let prayerTimesData = null;
        let prayerTimesInterval = null;
        let compassWatchId = null;
        const QIBLA_ANGLE_CAIRO = 135; // Qibla direction from Cairo in degrees

        async function loadPrayerTimes() {
            const container = document.getElementById('prayerTimesContainer');
            const loading = document.getElementById('prayerTimesLoading');
            const error = document.getElementById('prayerTimesError');
            
            loading.style.display = 'block';
            container.style.display = 'none';
            error.style.display = 'none';

            try {
                // Get today's date
                const today = new Date();
                const day = today.getDate();
                const month = today.getMonth() + 1; // 0-indexed
                const year = today.getFullYear();
                
                // Fetch prayer times for Cairo from Aladhan API
                const response = await fetch(`https://api.aladhan.com/v1/timings/${day}-${month}-${year}?latitude=30.0444&longitude=31.2357&method=5`);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    prayerTimesData = data.data;
                    displayPrayerTimes();
                    loading.style.display = 'none';
                    container.style.display = 'block';
                    
                    // Update countdown every second
                    if (prayerTimesInterval) clearInterval(prayerTimesInterval);
                    prayerTimesInterval = setInterval(updatePrayerCountdown, 1000);
                } else {
                    throw new Error('Invalid response');
                }
            } catch (err) {
                console.error('Failed to load prayer times:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
            }
        }

        function displayPrayerTimes() {
            if (!prayerTimesData) return;
            
            const timings = prayerTimesData.timings;
            const date = prayerTimesData.date;
            
            // Display dates
            document.getElementById('hijriDate').textContent = `${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year}`;
            document.getElementById('gregorianDate').textContent = `${date.readable}`;
            
            // Display prayer times
            document.getElementById('fajrTime').textContent = formatTime(timings.Fajr);
            document.getElementById('sunriseTime').textContent = formatTime(timings.Sunrise);
            document.getElementById('dhuhrTime').textContent = formatTime(timings.Dhuhr);
            document.getElementById('asrTime').textContent = formatTime(timings.Asr);
            document.getElementById('maghribTime').textContent = formatTime(timings.Maghrib);
            document.getElementById('ishaTime').textContent = formatTime(timings.Isha);
            
            updatePrayerCountdown();
        }

        function formatTime(time24) {
            // Convert 24-hour format to 12-hour format
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const now = new Date();
            const time = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            return time;
        }

        function updatePrayerCountdown() {
            if (!prayerTimesData) return;
            
            const timings = prayerTimesData.timings;
            const now = new Date();
            
            const prayers = [
                { name: 'Fajr', nameAr: 'ÿßŸÑŸÅÿ¨ÿ±', time: parseTime(timings.Fajr), id: 'fajrRow' },
                { name: 'Dhuhr', nameAr: 'ÿßŸÑÿ∏Ÿáÿ±', time: parseTime(timings.Dhuhr), id: 'dhuhrRow' },
                { name: 'Asr', nameAr: 'ÿßŸÑÿπÿµÿ±', time: parseTime(timings.Asr), id: 'asrRow' },
                { name: 'Maghrib', nameAr: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®', time: parseTime(timings.Maghrib), id: 'maghribRow' },
                { name: 'Isha', nameAr: 'ÿßŸÑÿπÿ¥ÿßÿ°', time: parseTime(timings.Isha), id: 'ishaRow' }
            ];
            
            // Find next prayer
            let nextPrayer = null;
            let currentPrayer = null;
            
            for (let i = 0; i < prayers.length; i++) {
                const prayer = prayers[i];
                const row = document.getElementById(prayer.id);
                
                if (now < prayer.time) {
                    if (!nextPrayer) {
                        nextPrayer = prayer;
                        row.classList.remove('passed');
                        row.classList.remove('active');
                    } else {
                        row.classList.remove('passed');
                        row.classList.remove('active');
                    }
                } else {
                    row.classList.add('passed');
                    row.classList.remove('active');
                    currentPrayer = prayer;
                }
            }
            
            // If no next prayer today, next prayer is Fajr tomorrow
            if (!nextPrayer) {
                nextPrayer = prayers[0];
                nextPrayer.time.setDate(nextPrayer.time.getDate() + 1);
            }
            
            // Highlight current prayer window
            if (currentPrayer) {
                const currentRow = document.getElementById(currentPrayer.id);
                const currentIndex = prayers.findIndex(p => p.name === currentPrayer.name);
                if (currentIndex === prayers.length - 1) {
                    // Between Isha and midnight - Isha is active
                    currentRow.classList.add('active');
                    currentRow.classList.remove('passed');
                }
            }
            
            // Update next prayer banner
            document.getElementById('nextPrayerName').textContent = `${nextPrayer.name} - ${nextPrayer.nameAr}`;
            document.getElementById('nextPrayerTime').textContent = formatTime(timings[nextPrayer.name]);
            
            // Calculate time remaining
            const diff = nextPrayer.time - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (hours > 0) {
                document.getElementById('timeRemaining').textContent = `in ${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                document.getElementById('timeRemaining').textContent = `in ${minutes}m ${seconds}s`;
            } else {
                document.getElementById('timeRemaining').textContent = `in ${seconds}s`;
            }
        }

        function startDeviceCompass() {
            // Check if device orientation is supported
            if (!window.DeviceOrientationEvent) {
                alert('Device orientation is not supported on this device.');
                return;
            }

            // Request permission for iOS 13+
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            activateCompass();
                        } else {
                            alert('Permission denied. Please enable motion sensors in your browser settings.');
                        }
                    })
                    .catch(console.error);
            } else {
                // Non-iOS devices or older iOS versions
                activateCompass();
            }
        }

        function activateCompass() {
            // Hide static compass, show device compass
            document.getElementById('qiblaStatic').style.display = 'none';
            document.getElementById('qiblaDeviceCompass').style.display = 'block';

            // Listen to device orientation
            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
            window.addEventListener('deviceorientation', handleOrientation, true);
        }

        function handleOrientation(event) {
            let heading = event.alpha; // Compass heading (0-360)
            
            if (heading === null) {
                // If alpha is not available, try webkitCompassHeading (iOS)
                heading = event.webkitCompassHeading;
            }

            if (heading !== null && heading !== undefined) {
                // Normalize heading to 0-360
                heading = Math.round(heading);
                
                // Calculate the rotation for the Qibla arrow
                // The arrow should point to Qibla (135¬∞) relative to North
                // So we rotate it by (Qibla angle - current heading)
                const qiblaRotation = QIBLA_ANGLE_CAIRO - heading;
                
                // Rotate the Qibla arrow (NOT the compass ring)
                const compassRing = document.getElementById('deviceCompassRing');
                if (compassRing) {
                    // Keep compass ring fixed, rotate the arrow inside it
                    const qiblaArrow = compassRing.parentElement.querySelector('.qibla-arrow-container');
                    if (qiblaArrow) {
                        qiblaArrow.style.transform = `translate(-50%, -50%) rotate(${qiblaRotation}deg)`;
                    }
                }
                
                // Update heading display
                document.getElementById('deviceHeading').textContent = `${heading}¬∞`;
                
                // Calculate difference from Qibla direction
                let diff = Math.abs(heading - QIBLA_ANGLE_CAIRO);
                if (diff > 180) diff = 360 - diff;
                
                // Update visual feedback
                const arrow = document.getElementById('qiblaDirectionArrow');
                const statusText = document.getElementById('qiblaStatusText');
                const instructionText = document.getElementById('qiblaInstructionText');
                const feedback = document.getElementById('qiblaVisualFeedback');
                
                if (diff < 5) {
                    feedback.style.background = 'linear-gradient(135deg, rgba(46, 125, 50, 0.2), rgba(76, 175, 80, 0.3))';
                    arrow.textContent = '‚úÖ';
                    arrow.style.fontSize = '5rem';
                    statusText.textContent = 'Perfect! Facing Qibla';
                    statusText.style.color = 'var(--success)';
                    instructionText.textContent = 'You are aligned with the Kaaba direction';
                } else if (diff < 15) {
                    feedback.style.background = 'linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.3))';
                    arrow.textContent = '‚ö†Ô∏è';
                    arrow.style.fontSize = '4.5rem';
                    statusText.textContent = 'Almost there!';
                    statusText.style.color = '#F57C00';
                    instructionText.textContent = `Rotate ${diff.toFixed(0)}¬∞ more`;
                } else if (diff < 45) {
                    feedback.style.background = 'rgba(33, 150, 243, 0.15)';
                    arrow.textContent = '‚Üª';
                    arrow.style.fontSize = '4rem';
                    statusText.textContent = 'Keep rotating';
                    statusText.style.color = '#2196F3';
                    instructionText.textContent = `${diff.toFixed(0)}¬∞ away from Qibla`;
                } else {
                    feedback.style.background = 'var(--bg-light)';
                    
                    // Show directional arrow based on which way to turn
                    if (qiblaRotation > 0 && qiblaRotation < 180) {
                        arrow.textContent = '‚Ü™Ô∏è';
                        instructionText.textContent = 'Turn clockwise (right)';
                    } else {
                        arrow.textContent = '‚Ü©Ô∏è';
                        instructionText.textContent = 'Turn counter-clockwise (left)';
                    }
                    arrow.style.fontSize = '4rem';
                    statusText.textContent = 'Rotate your body';
                    statusText.style.color = 'var(--text-primary)';
                }
            }
        }

        function stopDeviceCompass() {
            // Remove event listeners
            window.removeEventListener('deviceorientationabsolute', handleOrientation, true);
            window.removeEventListener('deviceorientation', handleOrientation, true);
            
            // Show static compass, hide device compass
            document.getElementById('qiblaStatic').style.display = 'block';
            document.getElementById('qiblaDeviceCompass').style.display = 'none';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(pageId).classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            // Load prayer times when Pray page is opened
            if (pageId === 'pray') {
                loadPrayerTimes();
            }
            
            // Display bookmarks when Bookmarks page is opened
            if (pageId === 'bookmarks') {
                // Sync translation dropdown with current mode
                const bookmarkTranslationSelect = document.getElementById('bookmarkTranslationMode');
                if (bookmarkTranslationSelect) {
                    bookmarkTranslationSelect.value = bookmarkTranslationMode;
                }
                // Ensure quranData is loaded before displaying
                if (quranData && quranData.length > 0) {
                    displayBookmarksPage();
                } else {
                    console.log('Waiting for Quran data to load...');
                    setTimeout(() => displayBookmarksPage(), 500);
                }
            }
            
            // Refresh verse display when showing memorize page
            if (pageId === 'memorize' && filteredVerses.length > 0) {
                displayVerseWithNavigation(currentVerseIndex);
            }
        }

        // Install to Home Screen Functions
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function isInstalled() {
            // Check if app is already installed (running in standalone mode)
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        function showInstallBanner() {
            // Only show on mobile devices that aren't already installed
            if (isMobile() && !isInstalled()) {
                const banner = document.getElementById('installBanner');
                const dismissed = localStorage.getItem('installBannerDismissed');
                
                // Don't show if user dismissed it
                if (!dismissed && banner) {
                    banner.style.display = 'block';
                }
            }
        }

        function closeInstallBanner() {
            const banner = document.getElementById('installBanner');
            if (banner) {
                banner.style.display = 'none';
                // Remember that user dismissed it
                localStorage.setItem('installBannerDismissed', 'true');
            }
        }

        async function installApp() {
            if (deferredPrompt) {
                // Show the install prompt (works on Android Chrome)
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    closeInstallBanner();
                }
                
                deferredPrompt = null;
            } else {
                // For iOS or browsers without PWA support, show instructions
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isIOS) {
                    alert('To install:\n\n1. Tap the Share button (‚éô)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to confirm');
                } else {
                    alert('To install:\n\n1. Open browser menu (‚ãÆ)\n2. Select "Add to Home screen" or "Install app"\n3. Follow the prompts');
                }
            }
        }

        // Listen for the beforeinstallprompt event (PWA install prompt)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        // Listen for successful installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            closeInstallBanner();
            deferredPrompt = null;
        });

        // Add event listeners and initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize app first
            initApp();
            
            // Show install banner for mobile users
            setTimeout(() => showInstallBanner(), 1000); // Show after 1 second delay
            
            // Send OTP button
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            if (sendOtpBtn) {
                sendOtpBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    sendOTP();
                });
            }
            
            // Verify OTP button
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            if (verifyOtpBtn) {
                verifyOtpBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    verifyOTP();
                });
            }
            
            // Resend OTP button
            const resendOtpBtn = document.getElementById('resendOtpBtn');
            if (resendOtpBtn) {
                resendOtpBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    resendOTP();
                });
            }
            
            // Change email button
            const changeEmailBtn = document.getElementById('changeEmailBtn');
            if (changeEmailBtn) {
                changeEmailBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    resetToEmailStep();
                });
            }
            
            // Allow Enter key on email input
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendOTP();
                    }
                });
            }
            
            // Allow Enter key on OTP input
            const otpInput = document.getElementById('otpInput');
            if (otpInput) {
                otpInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        verifyOTP();
                    }
                });
                
                // Auto-verify when 6 digits entered
                otpInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    // Only allow numbers
                    e.target.value = value.replace(/[^0-9]/g, '');
                    
                    // Auto-verify when complete
                    if (e.target.value.length === 6) {
                        setTimeout(() => verifyOTP(), 300);
                    }
                });
            }
        });
    </script>
</body>
</html>
